<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
    <title>ÿßŸèŸÜÿ≥ ÿ∑ŸÑÿß - ŸÇ€åŸÖÿ™ ŸÑÿ≠ÿ∏Ÿá‚Äåÿß€å ÿ∑ŸÑÿßÿå ÿßÿ±ÿ≤ Ÿà ÿ±ŸÖÿ≤ÿßÿ±ÿ≤</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="https://cdn.imgurl.ir/uploads/o361389_Picsart_26-01-30_17-44-50-500.png"
        sizes="any">
    <link rel="icon" type="image/png" href="https://cdn.imgurl.ir/uploads/o361389_Picsart_26-01-30_17-44-50-500.png"
        sizes="96x96">
    <link rel="apple-touch-icon" href="https://cdn.imgurl.ir/uploads/o361389_Picsart_26-01-30_17-44-50-500.png"
        sizes="192x192">

    <!-- Chart.js ÿ®ÿ±ÿß€å ŸÜŸÖŸàÿØÿßÿ±Ÿáÿß -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::selection {
            background: transparent;
            color: inherit;
        }

        *::-moz-selection {
            background: transparent;
            color: inherit;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #121212;
            min-height: 100vh;
            padding: 0;
            color: #e0e0e0;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            transition: background 0.3s ease;
        }

        body.light-mode {
            background: linear-gradient(135deg, #d8dce5 0%, #ccd4e0 100%);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 70px 10px 140px;
        }

        /* ===== Bottom Snack Bar ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 995;
            transition: all 0.3s ease;
        }

        body.dark-mode .bottom-nav {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top-color: rgba(255, 255, 255, 0.08);
        }

        .bottom-nav.hidden {
            transform: translateY(150px);
        }

        .nav-header {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        body.dark-mode .nav-header {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }

        body.light-mode .nav-header {
            border-bottom-color: rgba(0, 0, 0, 0.08);
        }

        .nav-datetime {
            font-size: 16px;
            font-weight: 900;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.3px;
            line-height: 1.2;
        }

        body.dark-mode .nav-datetime {
            color: #ffffff;
        }

        body.light-mode .nav-datetime {
            color: #000000;
        }

        .nav-bot-name {
            font-size: 13px;
            font-weight: 400;
            color: #999;
            opacity: 0.8;
            flex: 1;
            text-align: center;
        }

        body.dark-mode .nav-bot-name {
            color: #aaa;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .nav-tabs {
            display: flex;
            overflow: visible;
            scroll-behavior: smooth;
            gap: 0;
            padding: 10px 12px;
            margin: 12px 10px;
            background: rgba(0, 0, 0, 0.45);
            justify-content: center;
            align-items: center;
            border-radius: 30px;
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: calc(100% - 20px);
            position: relative;
            --indicator-left: 0;
            --indicator-width: 0;
        }

        .nav-tab:first-child {
            margin: 0;
        }

        .nav-tab:last-child {
            margin: 0;
        }

        .nav-tabs::before {
            content: '';
            position: absolute;
            top: 8px;
            left: calc(var(--indicator-left) + 5px);
            width: calc(var(--indicator-width) - 10px);
            height: calc(100% - 16px);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.25);
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .nav-tabs.init::before {
            transition: none;
        }

        body.dark-mode .nav-tabs {
            background: rgba(0, 0, 0, 0.5);
            border-color: rgba(255, 255, 255, 0.08);
        }

        body.light-mode .nav-tabs {
            background: #d8dce5;
            border-color: rgba(0, 0, 0, 0.15);
        }

        .nav-tabs::-webkit-scrollbar {
            height: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 13px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.65);
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            border-radius: 22px;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            transition: color 0.3s ease;
        }

        body.dark-mode .nav-tab {
            background: transparent;
            color: rgba(255, 255, 255, 0.65);
        }

        body.dark-mode .nav-tab:hover {
            color: rgba(255, 255, 255, 0.5);
        }

        body.light-mode .nav-tab {
            color: rgba(0, 0, 0, 0.75);
        }

        body.light-mode .nav-tab:hover {
            color: rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .nav-tab.active {
            color: rgba(255, 255, 255, 0.65);
            font-weight: 700;
            animation: activeColorChange 0.4s ease-in-out forwards;
        }

        @keyframes activeColorChange {
            from {
                color: rgba(255, 255, 255, 0.65);
            }

            to {
                color: white;
            }
        }

        body.light-mode .nav-tab.active {
            color: rgba(0, 0, 0, 0.75);
            font-weight: 700;
            animation: activeColorChangeLight 0.4s ease-in-out forwards;
        }

        @keyframes activeColorChangeLight {
            from {
                color: rgba(0, 0, 0, 0.75);
            }

            to {
                color: white;
            }
        }

        /* ===== Header ===== */
        .header {
            display: none;
        }

        /* ===== Search & Filter ===== */
        .controls {
            display: none;
        }

        /* ===== Search Container ===== */
        .search-container {
            padding: 15px 10px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: transparent;
            backdrop-filter: none;
            z-index: 992;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .search-container.hidden {
            transform: translateY(200px);
            opacity: 0;
            pointer-events: none;
        }

        body.light-mode .search-container {
            background: transparent;
            backdrop-filter: none;
        }

        .search-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: none;
            border-radius: 25px;
            background: white;
            color: #333;
            font-size: 14px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            outline: none;
        }

        .search-clear {
            position: absolute;
            left: 15px;
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            padding: 5px;
            display: none;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
            line-height: 1;
        }

        .search-clear:hover {
            color: #333;
            transform: scale(1.1);
        }

        .search-clear.visible {
            display: block;
        }

        body.dark-mode .search-clear {
            color: #aaa;
        }

        body.dark-mode .search-clear:hover {
            color: #e0e0e0;
        }

        body.dark-mode .search-input {
            background: #2d2d2d;
            color: #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .search-input::placeholder {
            color: #999;
        }

        /* ===== Price Ticker/Marquee ===== */
        .price-ticker {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 4px 0;
            margin: 10px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .ticker-content {
            display: flex;
            gap: 12px;
            padding: 0 0;
            animation: scroll-left 20s linear infinite;
            white-space: nowrap;
            will-change: transform;
        }

        .ticker-content:hover {
            animation-play-state: paused;
        }

        @keyframes scroll-left {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: #fff;
            font-weight: 600;
            font-size: 12px;
            min-width: max-content;
            padding: 5px 12px;
            background: rgba(30, 30, 60, 0.85);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(30, 30, 60, 0.15);
            backdrop-filter: blur(4px);
            flex-shrink: 0;
        }

        .ticker-symbol {
            font-weight: 700;
            opacity: 1;
            color: #fff;
            font-size: 11px;
            color: #bdbdbd;
            font-weight: 400;
            margin-top: 1px;
        }

        .ticker-price {
            color: #fff;
            font-weight: 700;
            font-size: 13px;
        }

        .ticker-change {
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.12);
        }

        .ticker-change.positive {
            color: #4ade80;
        }

        .ticker-change.negative {
            color: #ff6b6b;
        }

        body.light-mode .price-ticker {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body.dark-mode .search-input::placeholder {
            color: #aaa;
        }

        .search-input:focus {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* ===== Loading Spinner ===== */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== Price Grid ===== */
        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .price-card {
            background: #f9f9fb;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        body.dark-mode .price-card {
            background: #1e1e1e;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        body.light-mode .price-card {
            background: #f8f7f5;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .price-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .price-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: default;
            pointer-events: none;
            -webkit-tap-highlight-color: transparent;
        }

        .card-icon img {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
            cursor: default;
            display: block;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ensure all icons are uniform size and scaled consistently */
        .icon-container {
            width: 50px;
            height: 50px;
            min-width: 50px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 10px;
            background: transparent;
        }

        .card-icon img,
        .icon-container img,
        .card-icon-img {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
            display: block !important;
            border-radius: 10px !important;
        }

        .card-title {
            flex: 1;
        }

        .card-title h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        body.dark-mode .card-title h3 {
            color: #e0e0e0;
        }

        .card-title .symbol {
            font-size: 13px;
            color: #999;
            font-weight: 500;
        }

        body.dark-mode .card-title .symbol {
            color: #aaa;
        }

        .card-price {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        body.dark-mode .card-price {
            color: #7dd3ff;
        }

        .card-price .unit {
            font-size: 13px;
            color: #999;
        }

        body.dark-mode .card-price .unit {
            color: #aaa;
        }

        .card-change {
            display: flex;
            gap: 15px;
            padding: 10px 0;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
        }

        .change-item {
            flex: 1;
        }

        .change-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .change-value {
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .change-value.up {
            color: #10b981;
        }

        .change-value.down {
            color: #ef4444;
        }

        .change-value.neutral {
            color: #999;
        }

        .card-footer {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        body.dark-mode .card-footer {
            color: #aaa;
            border-top-color: #444;
        }

        .chart-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            width: 100%;
            transition: all 0.3s;
            -webkit-tap-highlight-color: transparent;
        }

        .chart-btn:hover {
            transform: scale(1.05);
        }

        /* ===== Modal ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 95%;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .modal-content {
            background: #1e1e1e;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        body.dark-mode .modal-header {
            border-bottom-color: #333;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }

        body.dark-mode .modal-header h2 {
            color: #e0e0e0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: all 0.3s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body.dark-mode .close-btn {
            color: #aaa;
        }

        .close-btn:hover {
            color: #333;
        }

        body.dark-mode .close-btn:hover {
            color: #e0e0e0;
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            margin: 20px 0;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 15px;
            box-sizing: border-box;
            display: block;
        }

        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        body.dark-mode .chart-container {
            background: rgba(102, 126, 234, 0.08);
        }

        /* ===== Responsive ===== */
        @media (max-width: 1200px) {
            .chart-container {
                height: 350px;
            }
        }

        @media (max-width: 768px) {
            .chart-container {
                height: 350px;
                padding: 10px;
                width: 100%;
                box-sizing: border-box;
            }

            .price-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .filter-tabs {
                width: 100%;
                justify-content: center;
            }

            .header h1 {
                font-size: 22px;
            }

            .modal-content {
                padding: 20px;
                width: 100%;
                max-width: 100%;
                max-height: 100vh;
                border-radius: 12px;
            }

            .chart-container {
                min-height: 350px;
                max-height: 60vh;
                width: 100%;
            }

            .nav-tabs {
                margin: 10px 10px;
                padding: 8px 10px;
                max-width: calc(100% - 20px);
            }

            .nav-tabs::before {
                top: 8px;
                left: calc(var(--indicator-left) + 5px);
                width: calc(var(--indicator-width) - 10px);
                height: calc(100% - 16px);
            }

            .nav-tab {
                padding: 12px 16px;
                font-size: 15px;
                min-height: 42px;
            }

            .nav-tab.active {
                transform: scale(1.05);
            }
        }

        @media (max-width: 480px) {
            .nav-tabs {
                margin: 8px 8px;
                padding: 7px 8px;
                max-width: calc(100% - 16px);
            }

            .nav-tabs::before {
                top: 7px;
                left: calc(var(--indicator-left) + 4px);
                width: calc(var(--indicator-width) - 8px);
                height: calc(100% - 14px);
            }

            .nav-tab {
                padding: 11px 14px;
                font-size: 13px;
                min-height: 40px;
            }

            .nav-datetime {
                font-size: 12px;
            }

            .nav-tab.active {
                transform: scale(1.04);
            }
        }

        /* ===== Empty State ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        body.dark-mode .empty-state {
            color: #e0e0e0;
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
            opacity: 0.8;
        }

        /* ===== Update Time ===== */
        .update-info {
            display: none;
        }

        /* ===== Skeleton Loading ===== */
        .skeleton-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        body.dark-mode .skeleton-card {
            background: #1e1e1e;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        body.light-mode .skeleton-card {
            background: #f8f7f5;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .skeleton-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        /* ===== Pull to Refresh Indicator ===== */
        .pull-to-refresh-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 998;
            pointer-events: none;
            height: 0;
            overflow: hidden;
            display: none;
        }

        .pull-to-refresh {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 120px;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: transparent;
            border: none;
            opacity: 0;
            pointer-events: none;
        }

        /* No animation for cards during refresh - just instant */
        body.refreshing .search-container,
        body.refreshing #priceGrid {
            transform: translateY(0);
            transition: none;
        }

        body:not(.refreshing) .search-container,
        body:not(.refreshing) #priceGrid {
            transform: translateY(0);
            transition: none;
        }

        body.light-mode .pull-to-refresh {
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.05) 0%, rgba(0, 0, 0, 0.02) 100%);
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }

        .pull-refresh-text {
            font-size: 13px;
            font-weight: 600;
            color: #667eea;
        }

        body.dark-mode .pull-refresh-text {
            color: white;
        }

        body.light-mode .pull-refresh-text {
            color: #000;
        }

        .pull-to-refresh-spinner {
            width: 50px;
            height: 50px;
            position: relative;
            display: inline-block;
        }

        .pull-to-refresh-spinner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #667eea;
            border-right-color: #667eea;
            animation: spin-fast 0.8s linear infinite;
        }

        .pull-to-refresh-spinner::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(100% - 16px);
            height: calc(100% - 16px);
            border-radius: 50%;
            border: 3px solid rgba(102, 126, 234, 0.2);
        }

        body.dark-mode .pull-to-refresh-spinner::before {
            border-top-color: white;
            border-right-color: white;
        }

        body.dark-mode .pull-to-refresh-spinner::after {
            border-color: rgba(255, 255, 255, 0.2);
        }

        body.light-mode .pull-to-refresh-spinner::before {
            border-top-color: #000;
            border-right-color: #000;
        }

        body.light-mode .pull-to-refresh-spinner::after {
            border-color: rgba(0, 0, 0, 0.2);
        }

        @keyframes spin-fast {
            to {
                transform: rotate(360deg);
            }
        }

        .skeleton-element {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-header {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .skeleton-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .skeleton-title {
            flex: 1;
        }

        .skeleton-title .line {
            height: 16px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-title .line:last-child {
            width: 60%;
        }

        .skeleton-price {
            height: 24px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .skeleton-change {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .skeleton-change-item {
            flex: 1;
        }

        .skeleton-change-item .line {
            height: 14px;
            margin-bottom: 6px;
            border-radius: 4px;
        }

        .skeleton-footer {
            height: 12px;
            width: 70%;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .skeleton-btn {
            height: 32px;
            border-radius: 6px;
        }

        /* ===== Chart Modal Loading ===== */
        .modal-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            flex-direction: column;
            gap: 20px;
        }

        .modal-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Chart Skeleton */
        .chart-skeleton {
            height: 400px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        /* ===== Chart Controls ===== */
        /* ===== Chart Modal Toolbar ===== */
        .chart-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            align-items: flex-end;
        }

        body.dark-mode .chart-toolbar {
            background: rgba(255, 255, 255, 0.05);
        }

        .toolbar-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 150px;
        }

        .toolbar-group label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        body.dark-mode .toolbar-group label {
            color: #e0e0e0;
        }

        /* ===== Dropdown Styles ===== */
        .dropdown-wrapper {
            position: relative;
            width: 100%;
        }

        .dropdown-toggle {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 6px;
            background: white;
            color: #333;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        body.dark-mode .dropdown-toggle {
            background: #2d2d2d;
            color: #e0e0e0;
            border-color: rgba(125, 211, 255, 0.3);
        }

        .dropdown-toggle:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        body.dark-mode .dropdown-toggle:hover {
            background: #333;
        }

        .dropdown-arrow {
            font-size: 10px;
            margin-right: 5px;
            transition: transform 0.3s;
        }

        .dropdown-toggle.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 5px;
            display: none;
        }

        body.dark-mode .dropdown-menu {
            background: #2d2d2d;
            border-color: #444;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .dropdown-menu.active {
            display: block;
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: transparent;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.4);
            border-radius: 3px;
        }

        .dropdown-category {
            padding: 4px 0;
            border-bottom: 1px solid #eee;
        }

        body.dark-mode .dropdown-category {
            border-bottom-color: #444;
        }

        .dropdown-category:last-child {
            border-bottom: none;
        }

        .category-title {
            padding: 6px 15px;
            font-size: 10px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        body.dark-mode .category-title {
            color: #aaa;
        }

        .dropdown-item {
            width: 100%;
            padding: 8px 15px;
            border: none;
            background: transparent;
            color: #333;
            font-size: 13px;
            text-align: right;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        body.dark-mode .dropdown-item {
            color: #e0e0e0;
        }

        .dropdown-item:hover {
            background: #f0f4ff;
        }

        body.dark-mode .dropdown-item:hover {
            background: rgba(102, 126, 234, 0.2);
        }

        .dropdown-item.active {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        /* ===== Responsive Chart Toolbar ===== */
        @media (max-width: 768px) {
            .chart-toolbar {
                gap: 10px;
                flex-wrap: nowrap;
            }

            .toolbar-group {
                min-width: auto;
                flex: 1;
            }

            .dropdown-menu.active {
                max-height: 400px;
            }

            .toolbar-group label {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .chart-toolbar {
                gap: 8px;
                flex-wrap: nowrap;
            }

            .toolbar-group {
                min-width: auto;
                flex: 1;
            }

            .dropdown-toggle {
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        /* ===== Old CSS (For compatibility) ===== */
        .chart-controls {
            display: none;
        }

        .chart-control-group {
            display: none;
        }

        .chart-type-buttons {
            display: none;
        }

        .timeframe-buttons {
            display: none;
        }

        /* Chart Crosshair */
        .chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 12px;
            pointer-events: none;
            z-index: 10;
            display: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 250px;
            word-wrap: break-word;
            white-space: nowrap;
        }

        .chart-tooltip.visible {
            display: block;
        }

        .chart-tooltip-row {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin: 4px 0;
        }

        .chart-tooltip-label {
            color: #aaa;
        }

        .chart-tooltip-value {
            color: white;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chart-type-buttons {
                max-height: 80px;
                gap: 6px;
            }

            .chart-type-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .timeframe-buttons {
                max-height: 120px;
            }

            .timeframe-btn {
                padding: 5px 10px;
                font-size: 11px;
                min-width: 36px;
            }
        }
    </style>
</head>

<body>
    <!-- Pull to Refresh Indicator -->
    <div class="pull-to-refresh-container" id="pullToRefreshContainer">
        <div class="pull-to-refresh" id="pullToRefreshIndicator">
            <div class="pull-to-refresh-spinner"></div>
            <div class="pull-refresh-text">ÿØÿ± ÿ≠ÿßŸÑ ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å...</div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üåç ÿßŸèŸÜÿ≥ ÿ∑ŸÑÿß</h1>
            <p>ŸÇ€åŸÖÿ™ ŸÑÿ≠ÿ∏Ÿá‚Äåÿß€å ÿ∑ŸÑÿßÿå ÿßÿ±ÿ≤ Ÿà ÿ±ŸÖÿ≤ÿßÿ±ÿ≤</p>
        </div>

        <!-- Update Info -->
        <div class="update-info">
            ‚è∞ ÿ¢ÿÆÿ±€åŸÜ ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å: <span class="time" id="updateTime">--:--</span>
            <span id="autoUpdateStatus"> | üîÑ ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿÆŸàÿØ⁄©ÿßÿ± ŸÅÿπÿßŸÑ ÿßÿ≥ÿ™</span>
        </div>

        <!-- Search Box -->
        <div class="search-container">
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="ÿ¨ÿ≥ÿ™ÿ¨Ÿà..." class="search-input">
                <button class="search-clear" id="searchClear" onclick="clearSearch()">√ó</button>
            </div>
        </div>

        <!-- Price Ticker/Marquee -->
        <div class="price-ticker">
            <div class="ticker-content" id="tickerContent">
                <!-- ÿ™€å⁄©ÿ± ŸÇ€åŸÖÿ™‚ÄåŸáÿß€å ŸÖŸáŸÖ ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿ±ŸàÿßŸÜ -->
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <p>ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿßÿ∑ŸÑÿßÿπÿßÿ™...</p>
        </div>

        <!-- Price Grid -->
        <div class="price-grid" id="priceGrid"></div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">üîç</div>
            <h3>ŸÜÿ™€åÿ¨Ÿá‚Äåÿß€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ</h3>
            <p>ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ÿ¥ŸÖÿß ŸÖÿ∑ÿßÿ®ŸÇ ÿ®ÿß Ÿá€å⁄Ü‚Äå⁄©ÿØÿßŸÖ ÿßÿ≤ ŸÜÿ™ÿß€åÿ¨ ŸÜ€åÿ≥ÿ™</p>
        </div>
    </div>

    <!-- Scroll to Top Button - Hidden -->
    <!-- ÿØ⁄©ŸÖŸá scroll to top ÿØ€å⁄Øÿ± ŸÜ€åÿßÿ≤ ŸÜ€åÿ≥ÿ™ ⁄ÜŸàŸÜ ÿµŸÅÿ≠Ÿá ÿØÿ± switchTab ÿÆŸàÿØ⁄©ÿßÿ± ÿ®Ÿá ÿ®ÿßŸÑÿß ŸÖ€å‚Äåÿ±ŸàÿØ -->


    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav" id="bottomNav">
        <div class="nav-header">
            <div class="nav-datetime"><span id="navDate">--/--/--</span> <span id="navTime">--:--</span></div>
            <div class="nav-bot-name">OunceGoldBot@</div>
            <button class="theme-toggle" id="themeToggle" onclick="toggleDarkMode()">üåô</button>
        </div>
        <div class="nav-tabs init">
            <button class="nav-tab active" onclick="switchTab('all')">ŸáŸÖŸá</button>
            <button class="nav-tab" onclick="switchTab('gold')">ÿ∑ŸÑÿß Ÿà ÿ≥⁄©Ÿá</button>
            <button class="nav-tab" onclick="switchTab('currency')">ÿßÿ±ÿ≤</button>
            <button class="nav-tab" onclick="switchTab('crypto')">ÿ±ŸÖÿ≤ ÿßÿ±ÿ≤</button>
        </div>
    </div>
    <div class="modal" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="chartModalTitle">ŸÜŸÖŸàÿØÿßÿ± ŸÇ€åŸÖÿ™</h2>
                    <p id="chartModalSymbol" style="color: #999; font-size: 14px; margin-top: 5px;"></p>
                </div>
                <button class="close-btn" onclick="closeChartModal()">‚úï</button>
            </div>

            <!-- Chart Controls Toolbar -->
            <div class="chart-toolbar">
                <!-- Chart Type Dropdown -->
                <div class="toolbar-group">
                    <label>üìä ŸÜŸàÿπ ŸÜŸÖŸàÿØÿßÿ±:</label>
                    <div class="dropdown-wrapper">
                        <button class="dropdown-toggle" id="chartTypeToggle" onclick="toggleChartTypeDropdown()">
                            <span id="chartTypeLabel">ÿÆÿ∑</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="chartTypeDropdown">
                            <!-- Candle Charts -->
                            <div class="dropdown-category">
                                <div class="category-title">üïØÔ∏è ÿ¥ŸÖÿπ</div>
                                <button class="dropdown-item" data-type="candles"
                                    onclick="selectChartType('candles')">ÿ¥ŸÖÿπ</button>
                                <button class="dropdown-item" data-type="hollow-candles"
                                    onclick="selectChartType('hollow-candles')">ÿ¥ŸÖÿπ ÿ™ŸàÿÆÿßŸÑ€å</button>
                            </div>
                            <!-- Line Charts -->
                            <div class="dropdown-category">
                                <div class="category-title">üìà ÿÆÿ∑€å</div>
                                <button class="dropdown-item active" data-type="line"
                                    onclick="selectChartType('line')">ÿÆÿ∑</button>
                                <button class="dropdown-item" data-type="line-markers"
                                    onclick="selectChartType('line-markers')">ÿÆÿ∑ ÿ®ÿß ŸÜÿ¥ÿßŸÜ⁄Øÿ±</button>
                                <button class="dropdown-item" data-type="step-line"
                                    onclick="selectChartType('step-line')">ÿÆÿ∑ ŸæŸÑ⁄©ÿßŸÜ€å</button>
                            </div>
                            <!-- Area Charts -->
                            <div class="dropdown-category">
                                <div class="category-title">üåä ŸÜÿßÿ≠€åŸá</div>
                                <button class="dropdown-item" data-type="area"
                                    onclick="selectChartType('area')">ŸÜÿßÿ≠€åŸá</button>
                            </div>
                            <!-- Bar Charts -->
                            <div class="dropdown-category">
                                <div class="category-title">üìä ŸÖ€åŸÑŸá‚ÄåŸáÿß Ÿà ÿ≥ÿ™ŸàŸÜ‚ÄåŸáÿß</div>
                                <button class="dropdown-item" data-type="bars"
                                    onclick="selectChartType('bars')">ŸÖ€åŸÑŸá‚ÄåŸáÿß</button>
                                <button class="dropdown-item" data-type="columns"
                                    onclick="selectChartType('columns')">ÿ≥ÿ™ŸàŸÜ‚ÄåŸáÿß</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeframe Dropdown -->
                <div class="toolbar-group">
                    <label>‚è±Ô∏è ÿ®ÿßÿ≤Ÿá ÿ≤ŸÖÿßŸÜ€å:</label>
                    <div class="dropdown-wrapper">
                        <button class="dropdown-toggle" id="timeframeToggle" onclick="toggleTimeframeDropdown()">
                            <span id="timeframeLabel">1ÿ±</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </button>
                        <div class="dropdown-menu" id="timeframeDropdown">
                            <!-- Minutes -->
                            <div class="dropdown-category">
                                <div class="category-title">ÿØŸÇ€åŸÇŸá</div>
                                <button class="dropdown-item" data-timeframe="1m" onclick="selectTimeframe('1m')">1
                                    ÿØŸÇ€åŸÇŸá</button>
                                <button class="dropdown-item" data-timeframe="3m" onclick="selectTimeframe('3m')">3
                                    ÿØŸÇ€åŸÇŸá</button>
                                <button class="dropdown-item" data-timeframe="5m" onclick="selectTimeframe('5m')">5
                                    ÿØŸÇ€åŸÇŸá</button>
                                <button class="dropdown-item" data-timeframe="15m" onclick="selectTimeframe('15m')">15
                                    ÿØŸÇ€åŸÇŸá</button>
                                <button class="dropdown-item" data-timeframe="30m" onclick="selectTimeframe('30m')">30
                                    ÿØŸÇ€åŸÇŸá</button>
                                <button class="dropdown-item" data-timeframe="45m" onclick="selectTimeframe('45m')">45
                                    ÿØŸÇ€åŸÇŸá</button>
                            </div>
                            <!-- Hours -->
                            <div class="dropdown-category">
                                <div class="category-title">ÿ≥ÿßÿπÿ™</div>
                                <button class="dropdown-item" data-timeframe="1h" onclick="selectTimeframe('1h')">1
                                    ÿ≥ÿßÿπÿ™</button>
                                <button class="dropdown-item" data-timeframe="2h" onclick="selectTimeframe('2h')">2
                                    ÿ≥ÿßÿπÿ™</button>
                                <button class="dropdown-item" data-timeframe="3h" onclick="selectTimeframe('3h')">3
                                    ÿ≥ÿßÿπÿ™</button>
                                <button class="dropdown-item" data-timeframe="4h" onclick="selectTimeframe('4h')">4
                                    ÿ≥ÿßÿπÿ™</button>
                            </div>
                            <!-- Days -->
                            <div class="dropdown-category">
                                <div class="category-title">ÿ±Ÿàÿ≤</div>
                                <button class="dropdown-item active" data-timeframe="1d"
                                    onclick="selectTimeframe('1d')">1
                                    ÿ±Ÿàÿ≤</button>
                                <button class="dropdown-item" data-timeframe="1w" onclick="selectTimeframe('1w')">1
                                    ŸáŸÅÿ™Ÿá</button>
                                <button class="dropdown-item" data-timeframe="1mo" onclick="selectTimeframe('1mo')">1
                                    ŸÖÿßŸá</button>
                                <button class="dropdown-item" data-timeframe="3mo" onclick="selectTimeframe('3mo')">3
                                    ŸÖÿßŸá</button>
                                <button class="dropdown-item" data-timeframe="6mo" onclick="selectTimeframe('6mo')">6
                                    ŸÖÿßŸá</button>
                                <button class="dropdown-item" data-timeframe="1y" onclick="selectTimeframe('1y')">1
                                    ÿ≥ÿßŸÑ</button>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Chart Container -->
            <div class="chart-container"
                style="width: 100%; height: 400px; position: relative; margin: 20px 0; border-radius: 12px; padding: 15px; background: rgba(102, 126, 234, 0.05);">
            </div>

            <script>
                // ‚öôÔ∏è Cloudflare Worker URL - API Proxy
                const WORKER_URL = 'https://ons-gold-tg.panytb.workers.dev';
                // ‚úÖ API Key ŸÖÿ≠ŸÅŸàÿ∏ ÿßÿ≥ÿ™ - ÿØÿ± Cloudflare Server ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØŸá
                const API_URL = `${WORKER_URL}/api/prices`;

                // Detect if running in Telegram Mini App
                const isTelegramMiniApp = () => {
                    return typeof window !== 'undefined' &&
                        (window.TelegramWebApp ||
                            window.Telegram ||
                            navigator.userAgent.includes('TelegramBot') ||
                            navigator.userAgent.includes('Telegram'));
                };

                // State
                let allData = {
                    gold: [],
                    currency: [],
                    cryptocurrency: []
                };
                let filteredData = [];
                let currentFilter = 'all';
                let chartInstance = null;

                // Chart state
                let chartState = {
                    currentSymbol: '',
                    currentName: '',
                    currentChartType: 'line',
                    currentTimeframe: '1d',
                    historicalData: [],
                    crosshairData: null
                };

                // Format Persian Digits
                function toPersianDigits(str) {
                    const englishDigits = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                    const persianDigits = ['€∞', '€±', '€≤', '€≥', '€¥', '€µ', '€∂', '€∑', '€∏', '€π'];

                    let result = str.toString();
                    for (let i = 0; i < englishDigits.length; i++) {
                        result = result.replace(new RegExp(englishDigits[i], 'g'), persianDigits[i]);
                    }
                    return result;
                }

                // Format Price with Separators (ÿ®ÿ±ÿß€å ÿßÿ±ÿ≤Ÿáÿß€å ÿßÿπÿ¥ÿßÿ±€å Ÿà ŸÖÿπŸÖŸàŸÑ€å)
                function formatPrice(price) {
                    // ÿß⁄Øÿ± ŸÇ€åŸÖÿ™ string Ÿà ÿ®ÿß 0. ÿ¥ÿ±Ÿàÿπ ŸÖ€å‚Äåÿ¥ŸàÿØÿå ÿØŸÇ€åŸÇÿßŸã ŸáŸÖÿßŸÜ ÿ±ÿß ŸÜŸÖÿß€åÿ¥ ÿ®ÿØŸá
                    if (typeof price === 'string' && price.startsWith('0.')) {
                        return price;
                    }

                    price = parseFloat(price);

                    // ÿß⁄Øÿ± ŸÇ€åŸÖÿ™ ÿÆ€åŸÑ€å Ÿæÿß€å€åŸÜ ÿ®ÿßÿ¥ÿØ (ŸÖÿ´ŸÑ ÿ±ŸÖÿ≤ÿßÿ±ÿ≤Ÿáÿß€å€å ⁄©Ÿá < 1)
                    if (price < 1) {
                        // ŸÜŸÖÿß€åÿ¥ 6 ÿ±ŸÇŸÖ ÿßÿπÿ¥ÿßÿ± ÿ®ÿ±ÿß€å ÿßÿ±ÿ≤Ÿáÿß€å ÿ®ÿ≥€åÿßÿ± Ÿæÿß€å€åŸÜ
                        return price.toFixed(6).replace(/\.?0+$/, '');
                    } else if (price < 100) {
                        // ŸÜŸÖÿß€åÿ¥ 2 ÿ±ŸÇŸÖ ÿßÿπÿ¥ÿßÿ± ÿ®ÿ±ÿß€å ÿßÿ±ÿ≤Ÿáÿß€å ⁄©ŸÖÿ™ÿ± ÿßÿ≤ 100
                        return price.toFixed(2).replace(/\.?0+$/, '');
                    } else {
                        // ŸÜŸÖÿß€åÿ¥ ÿ®ÿØŸàŸÜ ÿßÿπÿ¥ÿßÿ± + separator ÿ®ÿ±ÿß€å ÿßÿ±ÿ≤Ÿáÿß€å ÿ®ÿ≤ÿ±⁄Ø
                        return Math.round(price).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    }
                }

                // Load Icon with Retry Logic - ÿ®Ÿáÿ™ÿ± ÿ¥ÿØŸá
                function loadIconWithFallback(iconPath, symbol, urlBaseIcon = 'https://brsapi.ir/Api/Market/GCC/Icon') {
                    if (!iconPath) {
                        return createSymbolFallback(symbol);
                    }

                    const uniqueId = `icon-${symbol.replace(/[^a-zA-Z0-9]/g, '_')}`;

                    // ÿ¢ÿØÿ±ÿ≥‚ÄåŸáÿß€å ŸÖÿ™ÿπÿØÿØ ÿ®ÿ±ÿß€å ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ - ÿ∑ÿ®ŸÇ ŸÅÿ±ŸÖÿ™ API: {url_base_icon}/{size}/{path_icon}
                    const sizes = ['256x256', '128x128', '64x64', '32x32'];
                    const iconUrls = sizes.map(size => `${urlBaseIcon}/${size}/${iconPath}`);

                    // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßŸàŸÑ€å: 128x128 ÿ®ÿ±ÿß€å ŸÖŸàÿ®ÿß€åŸÑ Ÿà 256x256 ÿ®ÿ±ÿß€å ÿØÿ≥⁄©ÿ™ÿßŸæ
                    const isMobile = window.innerWidth <= 768;
                    const initialSize = isMobile ? '128x128' : '256x256';
                    const corsProxyUrl = `${urlBaseIcon}/${initialSize}/${iconPath}`;

                    return `<div id="${uniqueId}" class="icon-container" data-symbol="${symbol}" data-path="${iconPath}" style="width: 50px; height: 50px; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: transparent;">
                <img src="${corsProxyUrl}" 
                     alt="${symbol}" 
                     class="card-icon-img"
                     data-symbol="${symbol}"
                     data-icon-path="${iconPath}"
                     data-base-url="${urlBaseIcon}"
                     data-urls='${JSON.stringify(iconUrls)}'
                     style="width: 50px; height: 50px; border-radius: 10px; object-fit: contain; user-select: none; pointer-events: none; -webkit-user-drag: none; display: block;"
                     draggable="false"
                     referrerpolicy="no-referrer"
                     decoding="async"
                     >
            </div>`;
                }

                // Create Symbol Fallback with emoji
                function createSymbolFallback(symbol) {
                    // Symbol‚ÄåŸáÿß€å ÿ±ÿß€åÿ¨ Ÿà ÿ¢€å⁄©ŸàŸÜ‚ÄåŸáÿß€å ÿ¢ŸÜ
                    const symbolEmojis = {
                        'ÿ∑ŸÑÿß': 'ü•á',
                        'ÿßŸÜÿ≥ ÿ∑ŸÑÿß': 'ü•á',
                        'IR_GOLD': 'ü•á',
                        'ŸÜŸÇÿ±Ÿá': 'ü•à',
                        'ŸÖÿ≥': 'üî¥',
                        'USDT': 'üíµ',
                        'USD': 'üíµ',
                        'XAUUSD': 'ü•á',
                        'EUR': '‚Ç¨',
                        'GBP': '¬£',
                        'JPY': '¬•',
                        'BTC': '‚Çø',
                        'ETH': 'Œû',
                        'ADA': '‚Ç≥',
                        'XRP': '‚úï',
                        'DOGE': 'üêï',
                        'SOL': '‚óé',
                        'BNB': 'üî∂',
                    };

                    // Check by exact match first
                    let emoji = symbolEmojis[symbol];

                    // If not found, try partial match
                    if (!emoji) {
                        for (const [key, value] of Object.entries(symbolEmojis)) {
                            if (symbol.includes(key) || key.includes(symbol)) {
                                emoji = value;
                                break;
                            }
                        }
                    }

                    // Default fallback
                    if (!emoji) {
                        emoji = symbol.length > 0 ? symbol.charAt(0) : 'üí∞';
                    }

                    const isEmoji = emoji.match(/\p{Emoji}/u);

                    if (isEmoji) {
                        return `<div style="width: 50px; height: 50px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 28px; user-select: none; pointer-events: none;">${emoji}</div>`;
                    } else {
                        return `<div style="width: 50px; height: 50px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: white; text-align: center; padding: 5px; word-break: break-word; overflow: hidden;">${symbol.substring(0, 6)}</div>`;
                    }
                }

                // Setup Image Error Handlers - ÿ®Ÿáÿ®ŸàÿØ‚Äåÿ¥ÿØŸá ÿ®ÿ±ÿß€å Mini App
                function setupImageErrorHandlers() {
                    const isInMiniApp = isTelegramMiniApp();
                    console.log(`üîç setupImageErrorHandlers ÿ¥ÿ±Ÿàÿπ - Mini App: ${isInMiniApp}`);

                    if (isInMiniApp) {
                        console.log(`üì± Mini App ÿ™ÿ¥ÿÆ€åÿµ ÿØÿßÿØŸá ÿ¥ÿØ - timeout ÿ®ÿ±ÿß€å ÿ¢€å⁄©ŸàŸÜ‚ÄåŸáÿß ÿßŸÅÿ≤ÿß€åÿ¥ €åÿßŸÅÿ™`);
                    }

                    const images = document.querySelectorAll('.card-icon-img');
                    console.log(`üì∏ ÿ™ÿπÿØÿßÿØ ÿ¢€å⁄©ŸàŸÜ‚ÄåŸáÿß: ${images.length}`);

                    images.forEach(img => {
                        if (img.__handlersSetup) return; // ÿ™ÿß ÿØŸàÿ®ÿßÿ± ÿßÿ¨ÿ±ÿß ŸÜÿ¥ŸàÿØ
                        img.__handlersSetup = true;

                        const symbol = img.getAttribute('data-symbol');
                        const iconPath = img.getAttribute('data-icon-path');
                        const wrapper = img.parentElement;

                        console.log(`‚öôÔ∏è ÿ™ŸÜÿ∏€åŸÖ ŸáŸÜÿØŸÑÿ± ÿ®ÿ±ÿß€å ${symbol} (ŸÖÿ≥€åÿ±: ${iconPath})`);

                        // ÿß⁄Øÿ± ÿπ⁄©ÿ≥ ŸÇÿ®ŸÑÿßŸã ŸÑŸà⁄à ÿ¥ÿØŸá ÿ®ÿßÿ¥ÿØ
                        if (img.complete) {
                            if (img.naturalHeight === 0 && img.naturalWidth === 0) {
                                // ÿπ⁄©ÿ≥ ÿÆÿ±ÿßÿ® ÿßÿ≥ÿ™
                                console.warn(`üîÑ ÿπ⁄©ÿ≥ ${symbol} ÿÆÿ±ÿßÿ® ÿßÿ≥ÿ™ - ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ`);
                                tryNextSize(img, iconPath, wrapper, symbol, 0);
                            } else {
                                console.log(`‚úÖ ÿπ⁄©ÿ≥ ${symbol} ŸÇÿ®ŸÑÿßŸã ŸÑŸà⁄à ÿ¥ÿØŸá`);
                                img.style.display = 'block';
                            }
                        }

                        // ÿ®ÿ±ÿß€å ÿπ⁄©ÿ≥‚ÄåŸáÿß€å ÿ¨ÿØ€åÿØ
                        img.addEventListener('load', function () {
                            console.log(`‚úÖ ÿπ⁄©ÿ≥ ${symbol} ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ`);
                            this.style.display = 'block';
                        });

                        img.addEventListener('error', function () {
                            console.warn(`‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ${symbol}`);
                            tryNextSize(this, iconPath, wrapper, symbol, 0);
                        });

                        // Timeout ÿ®ÿ±ÿß€å ŸÖŸàÿßŸÇÿπ ÿ¢ŸÅŸÑÿß€åŸÜ €åÿß ÿ®ÿ≥€åÿßÿ± ⁄©ŸÜÿØ (ÿØÿ± Mini App ÿßŸÅÿ≤ÿß€åÿ¥ €åÿßŸÅÿ™Ÿá)
                        const timeoutDelay = isTelegramMiniApp() ? 12000 : 5000;
                        setTimeout(() => {
                            if (!img.__handlersSetup || img.__timeoutChecked) return;
                            img.__timeoutChecked = true;

                            if (!img.complete || (img.naturalHeight === 0 && img.naturalWidth === 0)) {
                                console.warn(`‚è±Ô∏è Timeout ÿ®ÿ±ÿß€å ${symbol} - ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ`);
                                tryNextSize(img, iconPath, wrapper, symbol, 0);
                            }
                        }, timeoutDelay);
                    });
                }

                // Try Next Image Size - ÿ®Ÿáÿ®ŸàÿØ‚Äåÿ¥ÿØŸá
                function tryNextSize(img, iconPath, wrapper, symbol, attemptCount = 0) {
                    const sizes = ['256x256', '128x128', '64x64', '32x32'];
                    const maxAttempts = sizes.length;
                    const baseUrl = img.getAttribute('data-base-url') || 'https://brsapi.ir/Api/Market/GCC/Icon';

                    console.log(`üîÑ ÿ™ŸÑÿßÿ¥ ${attemptCount + 1}/${maxAttempts} ÿ®ÿ±ÿß€å ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¢€å⁄©ŸàŸÜ ${symbol} (ÿ≥ÿß€åÿ≤: ${sizes[attemptCount]})`);

                    if (attemptCount >= maxAttempts) {
                        // ÿ™ŸÖÿßŸÖ ÿ≥ÿß€åÿ≤‚ÄåŸáÿß ŸÜÿßŸÖŸàŸÅŸÇ - ŸÜŸÖÿß€åÿ¥ fallback
                        console.warn(`‚ùå ÿ™ŸÖÿßŸÖ ÿ™ŸÑÿßÿ¥‚ÄåŸáÿß ÿ®ÿ±ÿß€å ${symbol} ŸÜÿßŸÖŸàŸÅŸÇ ÿ®ŸàÿØ - ŸÜŸÖÿß€åÿ¥ fallback`);
                        wrapper.innerHTML = createSymbolFallback(symbol);
                        return;
                    }

                    const nextSize = sizes[attemptCount];
                    // ÿ∑ÿ®ŸÇ ŸÅÿ±ŸÖÿ™ API: {url_base_icon}/{size}/{path_icon}
                    const isInMini = isTelegramMiniApp();
                    let newSrc = `${baseUrl}/${nextSize}/${iconPath}`;
                    // ÿØÿ± Mini App ŸÖŸÖ⁄©ŸÜ ÿßÿ≥ÿ™ cache €åÿß ŸÖÿ≠ÿØŸàÿØ€åÿ™ Ÿàÿ¨ŸàÿØ ÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥ÿØÿõ €å⁄© query string ÿ®ÿ±ÿß€å ÿ¥⁄©ÿ≥ÿ™ cache ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ
                    if (isInMini) {
                        newSrc += `?t=${Date.now()}`;
                    }
                    console.log(`üì• ÿØÿ±ÿÆŸàÿßÿ≥ÿ™: ${newSrc}`);

                    const newImg = document.createElement('img');
                    newImg.src = newSrc;
                    newImg.alt = symbol;
                    newImg.className = 'card-icon-img';
                    newImg.setAttribute('data-symbol', symbol);
                    newImg.setAttribute('data-icon-path', iconPath);
                    newImg.setAttribute('data-base-url', baseUrl);
                    newImg.style.cssText = img.style.cssText;
                    newImg.draggable = false;
                    // Avoid forcing crossorigin to improve compatibility inside Mini App WebView
                    try { newImg.referrerPolicy = 'no-referrer'; } catch (e) { }
                    try { newImg.loading = 'eager'; } catch (e) { }

                    const timeoutDelay = isTelegramMiniApp() ? 8000 : 3000;
                    const loadTimeout = setTimeout(() => {
                        // ÿß⁄Øÿ± ÿ®ÿπÿØ ÿßÿ≤ ÿ™ÿπ€å€åŸÜ ÿ¥ÿØŸá ŸÑŸàÿØ ŸÜÿ¥ÿØÿå ÿ≥ÿ±ÿßÿ∫ ÿ≥ÿß€åÿ≤ ÿ®ÿπÿØ€å
                        if (!newImg.complete) {
                            console.warn(`‚è±Ô∏è Timeout ÿ®ÿ±ÿß€å ${symbol} (ÿ≥ÿß€åÿ≤: ${nextSize})`);
                            tryNextSize(newImg, iconPath, wrapper, symbol, attemptCount + 1);
                        }
                    }, timeoutDelay);

                    newImg.addEventListener('load', function () {
                        clearTimeout(loadTimeout);
                        console.log(`‚úÖ ÿ¢€å⁄©ŸàŸÜ ${symbol} ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥ÿØ (ÿ≥ÿß€åÿ≤: ${nextSize})`);
                        this.style.display = 'block';
                        if (img.parentElement) {
                            img.replaceWith(this);
                        }
                    });

                    newImg.addEventListener('error', function () {
                        clearTimeout(loadTimeout);
                        console.warn(`‚ö†Ô∏è ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ${symbol} (ÿ≥ÿß€åÿ≤: ${nextSize})`);
                        tryNextSize(this, iconPath, wrapper, symbol, attemptCount + 1);
                    });

                    if (img.parentElement) {
                        img.replaceWith(newImg);
                    } else {
                        wrapper.innerHTML = '';
                        wrapper.appendChild(newImg);
                    }
                }

                // Format Time
                function formatTime(date) {
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${hours}:${minutes}`;
                }

                // Format Date (Jalali with English digits)
                function formatDateJalali(date) {
                    const jalaliDate = date.toLocaleDateString('fa-IR');
                    // ÿ™ÿ®ÿØ€åŸÑ ÿßÿπÿØÿßÿØ ŸÅÿßÿ±ÿ≥€å ÿ®Ÿá ÿßŸÜ⁄ØŸÑ€åÿ≥€å
                    return jalaliDate.replace(/\u06F0/g, '0')
                        .replace(/\u06F1/g, '1')
                        .replace(/\u06F2/g, '2')
                        .replace(/\u06F3/g, '3')
                        .replace(/\u06F4/g, '4')
                        .replace(/\u06F5/g, '5')
                        .replace(/\u06F6/g, '6')
                        .replace(/\u06F7/g, '7')
                        .replace(/\u06F8/g, '8')
                        .replace(/\u06F9/g, '9');
                }

                // Update bottom nav datetime
                function updateNavDateTime() {
                    const now = new Date();
                    document.getElementById('navDate').textContent = formatDateJalali(now);
                    document.getElementById('navTime').textContent = formatTime(now);
                }

                // Toggle Dark Mode
                function toggleDarkMode() {
                    document.body.classList.toggle('dark-mode');
                    document.body.classList.toggle('light-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                    localStorage.setItem('darkMode', isDark ? 'true' : 'false');
                }

                // Load dark mode preference
                function loadDarkModePreference() {
                    const isDark = localStorage.getItem('darkMode') !== 'false'; // Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ dark mode
                    if (isDark) {
                        document.body.classList.add('dark-mode');
                        document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
                    } else {
                        document.body.classList.add('light-mode');
                        document.getElementById('themeToggle').textContent = 'üåô';
                    }
                }

                // Simplified Scroll Manager
                let lastScrollTop = 0;

                window.addEventListener('scroll', () => {
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const bottomNav = document.getElementById('bottomNav');

                    // ŸÖŸÜÿ∑ŸÇ snack bar
                    if (scrollTop > lastScrollTop && scrollTop > 200) {
                        // scrolling down
                        bottomNav.classList.add('hidden');
                    } else {
                        // scrolling up
                        bottomNav.classList.remove('hidden');
                    }

                    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
                }, { passive: true });

                // Update Indicator Position
                function updateIndicator(skipTransition = false) {
                    const activeTab = document.querySelector('.nav-tab.active');
                    const navTabs = document.querySelector('.nav-tabs');

                    if (activeTab && navTabs) {
                        const tabRect = activeTab.getBoundingClientRect();
                        const containerRect = navTabs.getBoundingClientRect();

                        const offset = tabRect.left - containerRect.left;
                        const width = tabRect.width;

                        navTabs.style.setProperty('--indicator-left', `${offset}px`);
                        navTabs.style.setProperty('--indicator-width', `${width}px`);

                        // Remove init class to enable transition after first update
                        if (skipTransition && navTabs.classList.contains('init')) {
                            requestAnimationFrame(() => {
                                navTabs.classList.remove('init');
                            });
                        }
                    }
                }

                // Switch tab
                function switchTab(filter) {
                    currentFilter = filter;
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    event.target.classList.add('active');
                    updateIndicator();
                    filterAndRender();
                    // ÿµŸÅÿ≠Ÿá ÿ±ÿß ÿ®Ÿá ÿ¢ÿ±ŸàŸÖ€å ÿ®Ÿá ÿ®ÿßŸÑÿß ÿ®ÿ®ÿ±
                    smoothScrollToTop();
                }

                // Smooth scroll to top with custom timing
                function smoothScrollToTop(duration = 800) {
                    const start = window.pageYOffset || document.documentElement.scrollTop;
                    const startTime = performance.now();

                    const scroll = (currentTime) => {
                        const elapsed = currentTime - startTime;
                        const progress = Math.min(elapsed / duration, 1);

                        // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ easing function ÿ®ÿ±ÿß€å ÿ≠ÿ±⁄©ÿ™ ÿ∑ÿ®€åÿπ€å‚Äåÿ™ÿ±
                        const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                        const position = start * (1 - easeOutCubic);

                        window.scrollTo(0, position);

                        if (progress < 1) {
                            requestAnimationFrame(scroll);
                        }
                    };

                    requestAnimationFrame(scroll);
                }

                // Fetch Data from API (via Cloudflare Worker Proxy)
                async function fetchData() {
                    try {
                        document.getElementById('loadingState').style.display = 'none';
                        document.getElementById('priceGrid').innerHTML = '';
                        document.getElementById('emptyState').style.display = 'none';

                        // ŸÜŸÖÿß€åÿ¥ skeleton loading
                        const grid = document.getElementById('priceGrid');
                        const skeletonCount = 4;
                        for (let i = 0; i < skeletonCount; i++) {
                            grid.appendChild(createSkeletonCard());
                        }

                        // ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ÿßÿ≤ Worker proxy
                        const response = await fetch(`${API_URL}?section=gold,currency,cryptocurrency`);
                        const data = await response.json();

                        if (data.successful) {
                            // Store url_base_icon from API
                            const urlBaseIcon = data.url_base_icon || 'https://brsapi.ir/Api/Market/GCC/Icon';

                            // Process Gold Data
                            if (data.gold) {
                                allData.gold = [
                                    ...data.gold.ounce.map(item => ({ ...item, type: 'gold', category: 'ounce', url_base_icon: urlBaseIcon })),
                                    ...data.gold.type.map(item => ({ ...item, type: 'gold', category: 'type', url_base_icon: urlBaseIcon })),
                                    ...data.gold.coin.map(item => ({ ...item, type: 'gold', category: 'coin', url_base_icon: urlBaseIcon })),
                                    ...data.gold.coin_parsian.map(item => ({ ...item, type: 'gold', category: 'coin_parsian', url_base_icon: urlBaseIcon }))
                                ];
                            }

                            // Process Currency Data
                            if (data.currency && data.currency.free) {
                                allData.currency = data.currency.free.map(item => ({ ...item, type: 'currency', url_base_icon: urlBaseIcon }));
                            }

                            // Process Crypto Data
                            if (data.cryptocurrency) {
                                allData.cryptocurrency = data.cryptocurrency.map(item => ({ ...item, type: 'crypto', url_base_icon: urlBaseIcon }));
                                console.log('üîê Crypto data loaded:', allData.cryptocurrency.map(c => ({ symbol: c.symbol, price_toman: c.price_toman })));
                            }

                            // Update Filter and Render
                            filterAndRender();

                            // Update Time
                            document.getElementById('updateTime').textContent = formatTime(new Date());
                        } else {
                            showError('ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿßÿ≤ API');
                        }
                    } catch (error) {
                        console.error('ÿÆÿ∑ÿß:', error);
                        showError('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ™ÿµÿßŸÑ ÿ®Ÿá ÿ≥ÿ±Ÿàÿ±');
                    } finally {
                        document.getElementById('loadingState').style.display = 'none';
                    }
                }

                // Filter and Render
                function filterAndRender() {
                    let dataToRender = [];

                    if (currentFilter === 'all') {
                        dataToRender = [...allData.gold, ...allData.currency, ...allData.cryptocurrency];
                    } else if (currentFilter === 'gold') {
                        dataToRender = allData.gold;
                    } else if (currentFilter === 'currency') {
                        dataToRender = allData.currency;
                    } else if (currentFilter === 'crypto') {
                        dataToRender = allData.cryptocurrency;
                    }

                    // Apply Search Filter
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    if (searchTerm) {
                        dataToRender = dataToRender.filter(item => {
                            const name = item.name ? item.name.toLowerCase() : '';
                            const nameEn = item.name_en ? item.name_en.toLowerCase() : '';
                            const symbol = item.symbol ? item.symbol.toLowerCase() : '';
                            return name.includes(searchTerm) || nameEn.includes(searchTerm) || symbol.includes(searchTerm);
                        });
                    }

                    filteredData = dataToRender;

                    if (dataToRender.length === 0) {
                        document.getElementById('emptyState').style.display = 'block';
                        document.getElementById('priceGrid').innerHTML = '';
                    } else {
                        document.getElementById('emptyState').style.display = 'none';
                        renderPrices(dataToRender);
                        updatePriceTicker();
                    }
                }

                // Create Skeleton Card
                function createSkeletonCard() {
                    const card = document.createElement('div');
                    card.className = 'price-card skeleton-card';
                    card.innerHTML = `
                <div class="skeleton-header">
                    <div class="skeleton-element skeleton-icon"></div>
                    <div class="skeleton-title">
                        <div class="skeleton-element line" style="height: 18px;"></div>
                        <div class="skeleton-element line" style="height: 14px; width: 50%;"></div>
                    </div>
                </div>
                <div class="skeleton-element skeleton-price"></div>
                <div class="skeleton-change">
                    <div class="skeleton-change-item">
                        <div class="skeleton-element line" style="height: 12px; margin-bottom: 4px;"></div>
                        <div class="skeleton-element line" style="height: 14px;"></div>
                    </div>
                    <div class="skeleton-change-item">
                        <div class="skeleton-element line" style="height: 12px; margin-bottom: 4px;"></div>
                        <div class="skeleton-element line" style="height: 14px;"></div>
                    </div>
                </div>
                <div class="skeleton-element skeleton-footer"></div>
                <div class="skeleton-element skeleton-btn"></div>
            `;
                    return card;
                }

                // Render Price Cards
                function renderPrices(data) {
                    const grid = document.getElementById('priceGrid');
                    grid.innerHTML = '';

                    data.forEach(item => {
                        const card = createPriceCard(item);
                        grid.appendChild(card);
                    });

                    // Setup image error handlers ÿ®ÿπÿØ ÿßÿ≤ ÿ±ŸÜÿØÿ± - ŸÅŸàÿ±€å Ÿà ÿ®ÿπÿØ ÿßÿ≤ delay
                    setupImageErrorHandlers();
                    setTimeout(() => {
                        setupImageErrorHandlers();
                    }, 100);
                    setTimeout(() => {
                        setupImageErrorHandlers();
                    }, 500);
                }

                // Update Price Ticker with Key Items
                function updatePriceTicker() {
                    const tickerContent = document.getElementById('tickerContent');
                    if (!tickerContent) return;

                    // Target items to display in ticker
                    const tickerSymbols = [
                        'XAUUSD', 'IR_GOLD_18K', 'IR_GOLD_24K',
                        'IR_COIN_EMAMI', 'IR_COIN_BAHAR',
                        'USD', 'EUR', 'BTC', 'USDT'
                    ];
                    // Persian subtitles for each symbol
                    const tickerSubtitles = {
                        'XAUUSD': 'ÿßŸÜÿ≥ ÿ∑ŸÑÿß',
                        'IR_GOLD_18K': 'ÿ∑ŸÑÿß €±€∏ ÿπ€åÿßÿ±',
                        'IR_GOLD_24K': 'ÿ∑ŸÑÿß €≤€¥ ÿπ€åÿßÿ±',
                        'IR_COIN_EMAMI': 'ÿ≥⁄©Ÿá ÿßŸÖÿßŸÖ€å',
                        'IR_COIN_BAHAR': 'ÿ≥⁄©Ÿá ÿ®Ÿáÿßÿ± ÿ¢ÿ≤ÿßÿØ€å',
                        'USD': 'ÿØŸÑÿßÿ± ÿ¢ŸÖÿ±€å⁄©ÿß',
                        'EUR': '€åŸàÿ±Ÿà',
                        'BTC': 'ÿ®€åÿ™‚Äå⁄©Ÿà€åŸÜ',
                        'USDT': 'ÿ™ÿ™ÿ±'
                    };

                    let tickerItems = [];

                    // Search through allData to find target items
                    if (allData && typeof allData === 'object') {
                        // gold, currency, cryptocurrency are flat arrays
                        const searchArrays = [
                            ...(allData.gold || []),
                            ...(allData.currency || []),
                            ...(allData.cryptocurrency || [])
                        ];

                        console.log('üîç All available items:', searchArrays.map(i => i.symbol));
                        console.log('üìç Looking for:', tickerSymbols);

                        // Filter for target items
                        searchArrays.forEach(item => {
                            if (item && item.symbol && tickerSymbols.includes(item.symbol)) {
                                // Avoid duplicates
                                if (!tickerItems.find(t => t.symbol === item.symbol)) {
                                    tickerItems.push(item);
                                    console.log(`‚úÖ Found: ${item.symbol}`);
                                }
                            }
                        });
                    }

                    // Sort ticker items in the order specified
                    const sortedItems = [];
                    tickerSymbols.forEach(symbol => {
                        const item = tickerItems.find(t => t.symbol === symbol);
                        if (item) {
                            sortedItems.push(item);
                        } else {
                            console.warn(`‚ö†Ô∏è Not found: ${symbol}`);
                        }
                    });
                    tickerItems = sortedItems;

                    // Build ticker HTML
                    let tickerHTML = '';
                    console.log('üéØ updatePriceTicker - Found items:', tickerItems.map(i => i.symbol));
                    tickerItems.forEach(item => {
                        const change = parseFloat(item.change_percent) || 0;
                        const changeEmoji = change > 0 ? 'üìà' : change < 0 ? 'üìâ' : '‚û°Ô∏è';
                        const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : 'neutral';

                        // Persian subtitle
                        const subtitle = tickerSubtitles[item.symbol] || '';

                        let priceDisplay = '';
                        // ŸÜŸÖÿßÿØ€åŸÜ ÿ®ÿ±ÿß€å BTC Ÿà USDT
                        let icon = '';
                        if (item.symbol === 'BTC') {
                            icon = '<span style="font-size:18px;margin-left:4px;">‚Çø</span>';
                        } else if (item.symbol === 'USDT') {
                            icon = '<span style="font-size:18px;margin-left:4px;">üíµ</span>';
                        }

                        // ŸÜŸÖÿß€åÿ¥ ŸÇ€åŸÖÿ™ ÿ±€åÿßŸÑ€å ÿ®ÿ±ÿß€å ÿ±ŸÖÿ≤ÿßÿ±ÿ≤Ÿáÿß (BTC, USDT, etc.)
                        if ((item.type === 'crypto' || item.symbol === 'BTC' || item.symbol === 'USDT') && item.price_toman) {
                            // ŸÜŸÖÿß€åÿ¥ ŸÇ€åŸÖÿ™ ÿ±€åÿßŸÑ€å ÿ®ÿ±ÿß€å ÿ±ŸÖÿ≤ÿßÿ±ÿ≤Ÿáÿß
                            const rialPrice = parseFloat(item.price_toman) || 0;
                            priceDisplay = `<span class="ticker-price">${toPersianDigits(rialPrice.toLocaleString('fa-IR'))}</span><span class="unit">ÿ±€åÿßŸÑ</span>`;
                            console.log(`üí∞ ${item.symbol}: price_toman = ${item.price_toman}`);
                        } else {
                            // ÿ≥ÿß€åÿ± ŸÜŸÖÿßÿØŸáÿß ŸÖÿ´ŸÑ ŸÖ€åŸÜ€å ÿßŸæ
                            const price = parseFloat(item.price) || 0;
                            priceDisplay = `<span class="ticker-price">${toPersianDigits(price.toLocaleString('fa-IR'))}</span><span class="unit">${item.unit || ''}</span>`;
                        }

                        tickerHTML += `
                            <div class="ticker-item">
                                <div style="display:flex;flex-direction:column;align-items:flex-start;">
                                    <span class="ticker-symbol" title="${item.name || item.symbol}">${icon}${item.symbol}</span>
                                    <span class="ticker-subtitle" style="font-size:12px;opacity:0.8;">${subtitle}</span>
                                </div>
                                ${priceDisplay}
                                <span class="ticker-change ${changeClass}">${changeEmoji} ${toPersianDigits(Math.abs(change).toFixed(2))}%</span>
                            </div>
                        `;
                    });

                    // Seamless loop: duplicate content 3 times for true seamless infinite scroll
                    // Animation goes 0% to -100%, so content repeats 3x without jumping
                    console.log('üìä tickerHTML length:', tickerHTML.length);
                    console.log('üìù Ticker items count:', tickerItems.length);
                    tickerContent.innerHTML = tickerHTML + tickerHTML + tickerHTML;
                    console.log('‚úÖ Ticker content updated. Items in DOM:', tickerContent.querySelectorAll('.ticker-item').length);
                }

                // Create Price Card Element
                function createPriceCard(item) {
                    const card = document.createElement('div');
                    card.className = 'price-card';

                    const change = parseFloat(item.change_percent) || 0;
                    const changeClass = change > 0 ? 'up' : change < 0 ? 'down' : 'neutral';
                    const changeIcon = change > 0 ? 'üìà' : change < 0 ? 'üìâ' : '‚öñÔ∏è';

                    // ÿ≥ÿßÿÆÿ™ ÿ¢ÿØÿ±ÿ≥ ÿ¢€å⁄©ŸÜ ÿßÿ≤ API (ÿßÿ≤ path_icon Ÿà url_base_icon ÿØÿ± Ÿæÿßÿ≥ÿÆ API)
                    let iconElement = '';
                    if (item.path_icon) {
                        const baseUrl = item.url_base_icon || 'https://brsapi.ir/Api/Market/GCC/Icon';
                        iconElement = loadIconWithFallback(item.path_icon, item.symbol, baseUrl);
                    } else if (item.symbol) {
                        // Fallback: ŸÜŸÖÿß€åÿ¥ symbol ÿ®Ÿá ÿµŸàÿ±ÿ™ ŸÖÿ™ŸÜ€å ÿß⁄Øÿ± icon ŸÖŸàÿ¨ŸàÿØ ŸÜÿ®ÿßÿ¥ÿØ
                        iconElement = `<div style="width: 50px; height: 50px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; text-align: center; padding: 5px; word-break: break-word;">${item.symbol}</div>`;
                    } else {
                        iconElement = `<div style="width: 50px; height: 50px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; text-align: center; padding: 5px; word-break: break-word;">üí∞</div>`;
                    }

                    // ÿ®ÿ±ÿß€å ÿßÿ±ÿ≤Ÿáÿß€å ÿØ€åÿ¨€åÿ™ÿßŸÑ (crypto) ÿØŸà ŸÇ€åŸÖÿ™ ŸÜŸÖÿß€åÿ¥ ÿ®ÿØŸá (ÿØŸÑÿßÿ±€å Ÿà ÿ™ŸàŸÖÿßŸÜ€å)
                    let price = item.price;
                    let unit = item.unit;
                    let priceDisplay = '';

                    if (item.type === 'crypto') {
                        // ŸÇ€åŸÖÿ™ ÿØŸÑÿßÿ±€å
                        let dollarPrice = item.price;
                        if (item.symbol === 'USDT') {
                            dollarPrice = '1';
                        }
                        const formattedDollarPrice = formatPrice(dollarPrice);

                        // ŸÇ€åŸÖÿ™ ÿ™ŸàŸÖÿßŸÜ€å
                        const formattedTomanPrice = formatPrice(item.price_toman);

                        priceDisplay = `
                    <div class="card-price">
                        ${formattedDollarPrice}
                        <span class="unit">ÿØŸÑÿßÿ±</span>
                    </div>
                    <div class="card-price" style="color: #764ba2; margin-bottom: 5px;">
                        ${formattedTomanPrice}
                        <span class="unit">ÿ™ŸàŸÖÿßŸÜ</span>
                    </div>
                `;
                    } else {
                        price = formatPrice(price);
                        priceDisplay = `
                    <div class="card-price">
                        ${price}
                        <span class="unit">${unit}</span>
                    </div>
                `;
                    }

                    const changeValue = formatPrice(Math.abs(item.change_value || 0));

                    card.innerHTML = `
                <div class="card-header">
                    <div class="card-icon">
                        ${iconElement}
                    </div>
                    <div class="card-title">
                        <h3>${item.name}</h3>
                        <span class="symbol">${item.symbol}</span>
                    </div>
                </div>
                
                ${priceDisplay}
                
                <div class="card-change">
                    <div class="change-item">
                        <div class="change-label">ÿ™ÿ∫€å€åÿ± ŸÖŸÇÿØÿßÿ±</div>
                        <div class="change-value ${changeClass}">
                            ${changeIcon}
                            ${changeValue}
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-label">ÿ™ÿ∫€å€åÿ± ÿØÿ±ÿµÿØ</div>
                        <div class="change-value ${changeClass}">
                            ${changeIcon}
                            <span>${Math.abs(change).toFixed(2)}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    üìÖ ${item.date} ‚è∞ ${item.time}
                </div>
                
                <button class="chart-btn" onclick="openChartModal('${item.symbol}', '${item.name}')">
                    üìä ŸÜŸÖŸàÿØÿßÿ± ÿ™⁄©ŸÜ€å⁄©ÿßŸÑ
                </button>
            `;

                    return card;
                }

                // Show Error
                function showError(message) {
                    const grid = document.getElementById('priceGrid');
                    grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: white; padding: 40px;">‚ùå ${message}</div>`;
                }

                // Open Chart Modal
                async function openChartModal(symbol, name) {
                    console.log(`üîì openChartModal ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å ÿ¥ÿØ - symbol: ${symbol}, name: ${name}`);

                    const chartModalTitle = document.getElementById('chartModalTitle');
                    const chartModalSymbol = document.getElementById('chartModalSymbol');
                    const chartModalElement = document.getElementById('chartModal');
                    const chartTypeLabel = document.getElementById('chartTypeLabel');
                    const timeframeLabel = document.getElementById('timeframeLabel');
                    const zoomLevel = document.getElementById('zoomLevel');

                    if (!chartModalTitle || !chartModalSymbol || !chartModalElement) {
                        console.error('‚ùå ÿπŸÜÿßÿµÿ± ŸÖÿØÿßŸÑ Ÿæ€åÿØÿß ŸÜÿ¥ÿØŸÜÿØ');
                        return;
                    }

                    chartModalTitle.textContent = `ŸÜŸÖŸàÿØÿßÿ± ŸÇ€åŸÖÿ™ - ${name}`;
                    chartModalSymbol.textContent = symbol;
                    chartModalElement.classList.add('active');

                    // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ overflow hidden ÿ®Ÿá body
                    document.body.classList.add('modal-open');

                    // ÿ∞ÿÆ€åÿ±Ÿá state
                    chartState.currentSymbol = symbol;
                    chartState.currentName = name;
                    chartState.currentChartType = 'line';
                    chartState.currentTimeframe = '1d';
                    currentZoom = 1;

                    // Reset dropdowns
                    if (chartTypeLabel) chartTypeLabel.textContent = 'ÿÆÿ∑';
                    if (timeframeLabel) timeframeLabel.textContent = '1ÿ±';
                    if (zoomLevel) zoomLevel.textContent = '100%';

                    document.querySelectorAll('#chartTypeDropdown .dropdown-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-type') === 'line') {
                            item.classList.add('active');
                        }
                    });

                    document.querySelectorAll('#timeframeDropdown .dropdown-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-timeframe') === '1d') {
                            item.classList.add('active');
                        }
                    });

                    // ŸÜŸÖÿß€åÿ¥ loading ÿ®ÿ±ÿß€å ŸÜŸÖŸàÿØÿßÿ±
                    const chartContainer = document.querySelector('.chart-container');
                    if (!chartContainer) {
                        console.error('‚ùå chartContainer Ÿæ€åÿØÿß ŸÜÿ¥ÿØ');
                        return;
                    }

                    chartContainer.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px;">
                    <div style="width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="color: #999; font-size: 14px;">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÜŸÖŸàÿØÿßÿ±...</p>
                </div>
            `;

                    // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿßŸàŸÑ€åŸá
                    console.log(`‚è≥ fetchHistoryData ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å ŸÖ€å‚Äåÿ¥ŸàÿØ ÿ®ÿ±ÿß€å: ${symbol}`);
                    await fetchHistoryData(symbol);
                    console.log(`‚úÖ fetchHistoryData ÿ™ŸÖÿßŸÖ ÿ¥ÿØ`);
                }

                // Close Chart Modal
                function closeChartModal() {
                    document.getElementById('chartModal').classList.remove('active');
                    // ÿ≠ÿ∞ŸÅ overflow hidden ÿßÿ≤ body
                    document.body.classList.remove('modal-open');
                }

                // Fetch History Data - timeframe ⁄©€í ÿ≥ÿßÿ™⁄æ
                async function fetchHistoryData(symbol) {
                    try {
                        console.log(`üì• ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿ®ÿ±ÿß€å: ${symbol} - ${chartState.currentTimeframe}`);
                        const chartContainer = document.querySelector('.chart-container');

                        // ÿ™ÿπ€å€åŸÜ ŸÜŸàÿπ history ÿ®ÿ± ÿßÿ≥ÿßÿ≥ timeframe
                        const timeframe = chartState.currentTimeframe;
                        let historyType = 1; // Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂: 24h
                        let url = '';

                        // ÿß⁄Øÿ± timeframe = 1d ÿßÿ≥ÿ™
                        // ÿØÿßÿØŸá‚ÄåŸáÿß€å 24 ÿ≥ÿßÿπÿ™€å ÿßÿ≤ API ŸÖÿ≥ÿ™ŸÇ€åŸÖ ÿ®⁄Ø€åÿ± (history=1)
                        if (timeframe === '1d') {
                            console.log(`üì± ÿØÿ±€åÿßŸÅÿ™ 24 ÿ≥ÿßÿπÿ™Ÿá - history=1`);
                            url = `${API_URL}?history=1&symbol=${symbol}`;
                            historyType = 1;
                        } else if (['1w', '1mo', '3mo', '6mo', '1y'].includes(timeframe)) {
                            // ÿ®ÿ±ÿß€å ÿ±Ÿàÿ≤€å/ŸáŸÅÿ™⁄Ø€å/ŸÖÿßŸáÿßŸÜŸá ÿßÿ≤ OHLC ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åŸÖ
                            console.log(`üìÖ ÿØÿ±€åÿßŸÅÿ™ ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿ±Ÿàÿ≤€å - history=2`);
                            url = `${API_URL}?history=2&symbol=${symbol}&timeframe=${timeframe}`;
                            historyType = 2;
                        } else {
                            // ÿ®ÿ±ÿß€å ÿØŸÇ€åŸÇ€å/ÿ≥ÿßÿπÿßÿ™€å
                            console.log(`üïê ÿØÿ±€åÿßŸÅÿ™ ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿØŸÇ€åŸÇ€å - history=1`);
                            url = `${API_URL}?history=1&symbol=${symbol}&timeframe=${timeframe}`;
                            historyType = 1;
                        }

                        console.log(`üîó URL: ${url}`);

                        let response;
                        try {
                            response = await fetch(url);
                        } catch (fetchError) {
                            console.error('‚ùå ÿÆÿ∑ÿß ÿØÿ± fetch:', fetchError);
                            chartContainer.innerHTML = '<p style="text-align:center; color:#666;">‚ö†Ô∏è ÿÆÿ∑ÿß ÿØÿ± ÿßÿ™ÿµÿßŸÑ: ' + fetchError.message + '</p>';
                            return;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        let data;
                        try {
                            data = await response.json();
                        } catch (parseError) {
                            console.error('‚ùå ÿÆÿ∑ÿß ÿØÿ± parsing JSON:', parseError);
                            chartContainer.innerHTML = '<p style="text-align:center; color:#666;">‚ö†Ô∏è ÿÆÿ∑ÿß ÿØÿ± Ÿæÿ±ÿØÿßÿ≤ÿ¥ ÿØÿßÿØŸá</p>';
                            return;
                        }

                        console.log(`üìä Ÿæÿßÿ≥ÿÆ API (history=${historyType}, timeframe=${timeframe}):`, data);

                        // ÿ®ÿ±ÿ±ÿ≥€å ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿØÿ±€åÿßŸÅÿ™€å
                        let processedData = [];

                        if (historyType === 2 && data.history_daily && Array.isArray(data.history_daily)) {
                            // OHLC ÿØÿßÿØŸá‚ÄåŸáÿß (ÿ±Ÿàÿ≤€å)
                            console.log(`‚úÖ ÿØÿßÿØŸá‚ÄåŸáÿß€å OHLC ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿØ: ${data.history_daily.length} ÿ±⁄©Ÿàÿ±ÿØ`);
                            processedData = data.history_daily.map((item, idx) => ({
                                date: item.date,
                                time: '12:00', // ÿ®ÿ±ÿß€å ÿ±Ÿàÿ≤€åÿå ŸàŸÇÿ™ ÿ±ÿß 12:00 ŸÇÿ±ÿßÿ± ŸÖ€å‚ÄåÿØŸá€åŸÖ
                                open: item.open,
                                high: item.high,
                                low: item.low,
                                close: item.close,
                                price: item.close,
                                change_percent: ((item.close - item.open) / item.open * 100).toFixed(2)
                            }));
                        } else if (data.history_24h && Array.isArray(data.history_24h)) {
                            // ÿØÿßÿØŸá‚ÄåŸáÿß€å 24 ÿ≥ÿßÿπÿ™€å
                            console.log(`‚úÖ ÿØÿßÿØŸá‚ÄåŸáÿß€å 24h ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿØ: ${data.history_24h.length} ÿ±⁄©Ÿàÿ±ÿØ`);
                            processedData = data.history_24h;
                        } else if (data.history && Array.isArray(data.history)) {
                            // ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ™ÿßÿ±€åÿÆ€å ÿπŸÖŸàŸÖ€å
                            console.log(`‚úÖ ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ™ÿßÿ±€åÿÆ€å ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿØ: ${data.history.length} ÿ±⁄©Ÿàÿ±ÿØ`);
                            processedData = data.history;
                        } else {
                            console.error('‚ùå ÿØÿßÿØŸá ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿØÿ±€åÿßŸÅÿ™ ŸÜÿ¥ÿØ €åÿß ÿÆÿßŸÑ€å ÿßÿ≥ÿ™');
                            console.error('ÿØÿßÿØŸá API:', data);
                            console.error('⁄©ŸÑ€åÿØŸáÿß€å ŸÖŸàÿ¨ŸàÿØ ÿØÿ± ÿØÿßÿØŸá:', Object.keys(data || {}));
                            chartContainer.innerHTML = '<p style="text-align:center; color:#666;">‚ö†Ô∏è ÿÆÿ∑ÿß: ÿØÿßÿØŸá ÿ™ÿßÿ±€åÿÆ⁄ÜŸá ÿØÿ± ÿØÿ≥ÿ™ÿ±ÿ≥ ŸÜ€åÿ≥ÿ™</p>';
                            return;
                        }

                        // ÿ®ÿ±ÿ±ÿ≥€å ÿß⁄Øÿ± processedData ÿÆÿßŸÑ€å ÿßÿ≥ÿ™
                        if (!processedData || processedData.length === 0) {
                            console.error('‚ùå processedData ÿÆÿßŸÑ€å ÿßÿ≥ÿ™ €åÿß undefined');
                            chartContainer.innerHTML = '<p style="text-align:center; color:#666;">‚ö†Ô∏è ÿÆÿ∑ÿß: Ÿá€å⁄Ü ÿØÿßÿØŸá‚Äåÿß€å ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ</p>';
                            return;
                        }

                        // Sorting ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿ™ÿßÿ±€åÿÆ Ÿà ŸàŸÇÿ™ - ÿßÿ®ÿ™ÿØÿßÿ¶€å sorting
                        processedData.sort((a, b) => {
                            // ŸÖŸÇÿß€åÿ≥Ÿá string ÿ®Ÿá ÿµŸàÿ±ÿ™ ŸÖÿ≥ÿ™ŸÇ€åŸÖ (ÿ¨ŸÑÿßŸÑ€å ÿ™ÿßÿ±€åÿÆ YYYY/MM/DD ŸÅÿßÿ±ŸÖÿ™ ŸÖ€å⁄∫ €Å€í)
                            if (a.date !== b.date) {
                                return a.date.localeCompare(b.date);
                            }
                            // ÿß⁄Øÿ± ÿ™ÿßÿ±€åÿÆ ÿ®ÿ±ÿßÿ®ÿ± €Å€í ÿ™Ÿà time ⁄©ÿß ŸÖŸàÿßÿ≤ŸÜ€Å ⁄©ÿ±€å⁄∫
                            return (a.time || '00:00').localeCompare(b.time || '00:00');
                        });

                        // ŸÅ€åŸÑÿ™ÿ± ⁄©ÿ±€å⁄∫ ŸÅŸÇÿ∑ ÿ®ÿ±ÿß€å history=2 (ÿ±Ÿàÿ≤€å ÿØÿßÿØŸá)
                        // ÿ®ÿ±ÿß€å history=1 (24h)ÿå ŸÅ€åŸÑÿ™ÿ± ⁄©ŸÜ ÿß⁄Øÿ± timeframe = 1d ŸÜÿ®ÿßÿ¥ÿØ (ÿØŸÇ€åŸÇ€å/ÿ≥ÿßÿπÿßÿ™€å)
                        if (historyType === 2) {
                            processedData = filterDataByTimeframe(processedData, timeframe);
                            console.log(`‚úÖ ŸÅ€åŸÑÿ™ÿ± ÿ¥ÿØŸá ÿ®ÿ±ÿß€å ${timeframe} (ÿ±Ÿàÿ≤€å): ${processedData.length} ÿ±⁄©Ÿàÿ±ÿØ`);
                        } else if (historyType === 1 && timeframe !== '1d') {
                            // ÿ®ÿ±ÿß€å history=1 Ÿà timeframe ÿ∫€åÿ± ÿßÿ≤ 1dÿå ŸÅ€åŸÑÿ™ÿ± ⁄©ŸÜ
                            processedData = filterDataByTimeframe(processedData, timeframe);
                            console.log(`‚úÖ ŸÅ€åŸÑÿ™ÿ± ÿ¥ÿØŸá ÿ®ÿ±ÿß€å ${timeframe} (ÿØŸÇ€åŸÇ€å/ÿ≥ÿßÿπÿßÿ™€å): ${processedData.length} ÿ±⁄©Ÿàÿ±ÿØ`);
                        } else {
                            console.log(`‚úÖ ÿØÿßÿØŸá‚ÄåŸáÿß€å ${timeframe}: ${processedData.length} ÿ±⁄©Ÿàÿ±ÿØ (ÿ®ÿØŸàŸÜ ŸÅ€åŸÑÿ™ÿ±)`);
                        }

                        chartState.historicalData = processedData;
                        const name = data.name || chartState.currentName || symbol;

                        console.log(`üé® ÿ±ŸÜÿØÿ± ŸÜŸÖŸàÿØÿßÿ± - symbol: ${symbol}, name: ${name}, data points: ${processedData.length}, type: ${chartState.currentChartType}`);

                        renderChart(processedData, symbol, name);
                    } catch (error) {
                        console.error('‚ùå ÿÆÿ∑ÿß ÿØÿ± ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ™ÿßÿ±€åÿÆ⁄ÜŸá:', error);
                        const chartContainer = document.querySelector('.chart-container');
                        chartContainer.innerHTML = '<p style="text-align:center; color:#666;">‚ö†Ô∏è ÿÆÿ∑ÿß ÿØÿ± ÿßÿ™ÿµÿßŸÑ ÿ®Ÿá ÿ≥ÿ±Ÿàÿ±: ' + error.message + '</p>';
                    }
                }

                // Filter data by timeframe
                function filterDataByTimeframe(data, timeframe) {
                    if (!data || data.length === 0) return data;

                    // ÿ®ÿ±ÿß€å ÿ±Ÿàÿ≤€å/ŸáŸÅÿ™⁄Ø€å/ŸÖÿßŸáÿßŸÜŸá ⁄à€åŸπÿß ⁄©€í ŸÑ€å€í
                    const dayCounts = {
                        '1d': 1,      // 24 ÿ≥ÿßÿπÿ™ ÿßÿÆ€åÿ± = 1 ÿ±Ÿàÿ≤
                        '1w': 7,      // 7 ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ
                        '1mo': 30,    // 30 ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ
                        '3mo': 90,    // 90 ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ
                        '6mo': 180,   // 180 ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ
                        '1y': 365     // 365 ÿ±Ÿàÿ≤ ŸÇÿ®ŸÑ
                    };

                    // ÿ®ÿ±ÿß€å ÿØŸÇ€åŸÇ€å/ÿ≥ÿßÿπÿßÿ™€å ⁄à€åŸπÿß ⁄©€í ŸÑ€å€í
                    const minuteCounts = {
                        '1m': 1,
                        '3m': 3,
                        '5m': 5,
                        '15m': 15,
                        '30m': 30,
                        '45m': 45,
                        '1h': 60,
                        '2h': 120,
                        '3h': 180,
                        '4h': 240
                    };

                    // ÿ±Ÿàÿ≤€å ⁄à€åŸπÿß ⁄©€í ŸÑ€å€í
                    if (dayCounts[timeframe]) {
                        const dayCount = dayCounts[timeframe];
                        // ÿ¢ÿÆÿ±€å N ÿ±⁄©Ÿàÿ±ÿØ ÿ®ÿ±⁄Øÿ±ÿØÿßŸÜ (€Åÿ± ÿ±⁄©Ÿàÿ±⁄à ÿß€å⁄© ÿØŸÜ €Å€í)
                        const filtered = data.slice(-dayCount);
                        console.log(`üìÖ ŸÅ€åŸÑÿ™ÿ± ÿ¥ÿØŸá ÿ®ÿ±ÿß€å ${timeframe}: ÿ¢ÿÆÿ±€å ${filtered.length} ÿ±Ÿàÿ≤`);
                        return filtered;
                    }

                    // ÿØŸÇ€åŸÇ€å ⁄à€åŸπÿß ⁄©€í ŸÑ€å€í
                    if (minuteCounts[timeframe]) {
                        const minuteCount = minuteCounts[timeframe];
                        // ÿ¢ÿÆÿ±€å N ÿ±⁄©Ÿàÿ±ÿØ ÿ®ÿ±⁄Øÿ±ÿØÿßŸÜ
                        const filtered = data.slice(-minuteCount);
                        console.log(`üïê ŸÅ€åŸÑÿ™ÿ± ÿ¥ÿØŸá ÿ®ÿ±ÿß€å ${timeframe}: ÿ¢ÿÆÿ±€å ${filtered.length} ŸÖŸÜŸπ`);
                        return filtered;
                    }

                    // Default: ÿ™ŸÖÿßŸÖ ⁄à€åŸπÿß
                    return data;
                }

                // Prepare OHLC data for candlestick charts
                function prepareOHLCData(data, timeframe) {
                    // ÿ≥ÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿ®ÿ±ÿß€å ÿß⁄©ŸÜŸàŸÜ - ÿ®ÿπÿØÿßŸã ÿ®ÿß€åÿØ ÿßÿ≤ API ÿØÿßÿØŸá‚ÄåŸáÿß€å OHLC ÿ±ÿß ÿ®⁄Ø€åÿ±€åÿØ
                    const ohlcData = [];

                    for (let i = 0; i < Math.min(data.length - 1, data.length); i++) {
                        const current = data[i];
                        const next = data[i + 1];

                        const price = parseFloat(current.price);
                        const nextPrice = parseFloat(next.price);

                        ohlcData.push({
                            date: current.date,
                            time: current.time,
                            open: price,
                            high: Math.max(price, nextPrice),
                            low: Math.min(price, nextPrice),
                            close: nextPrice,
                            change_percent: current.change_percent,
                            originalData: current
                        });
                    }

                    return ohlcData;
                }

                // Render Chart with different chart types - ÿ®Ÿáÿ™ÿ±‚Äåÿ¥ÿØŸá ÿ®ÿ±ÿß€å responsive
                function renderChart(historyData, symbol, name) {
                    console.log(`üé® renderChart ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å ÿ¥ÿØ - symbol: ${symbol}, name: ${name}, data length: ${historyData.length}`);

                    const chartContainer = document.querySelector('.chart-container');

                    if (!chartContainer) {
                        console.error('‚ùå chartContainer €åÿßŸÅÿ™ ŸÜÿ¥ÿØ');
                        return;
                    }

                    // ÿ®ÿ±ÿ±ÿ≥€å ÿß⁄Øÿ± ÿØÿßÿØŸá ÿÆÿßŸÑ€å ÿßÿ≥ÿ™
                    if (!historyData || historyData.length === 0) {
                        console.error('‚ùå historicalData ÿÆÿßŸÑ€å ÿßÿ≥ÿ™');
                        chartContainer.innerHTML = '<p style="text-align:center; color:#666;">‚ö†Ô∏è ÿÆÿ∑ÿß: Ÿá€å⁄Ü ÿØÿßÿØŸá‚Äåÿß€å ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ</p>';
                        return;
                    }

                    // ÿ≠ÿ∞ŸÅ ŸÜŸÖŸàÿØÿßÿ± ŸÇÿ®ŸÑ€å
                    if (chartInstance) {
                        chartInstance.destroy();
                    }

                    // ÿ≠ÿ∞ŸÅ skeleton loading Ÿà ÿ®ÿßÿ≤ÿ≥ÿßÿ≤€å canvas
                    chartContainer.innerHTML = '<canvas id="priceChart"></canvas>';

                    const canvas = document.getElementById('priceChart');
                    if (!canvas) {
                        console.error('‚ùå canvas €åÿßŸÅÿ™ ŸÜÿ¥ÿØ');
                        return;
                    }

                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        console.error('‚ùå 2d context €åÿßŸÅÿ™ ŸÜÿ¥ÿØ');
                        return;
                    }

                    // ÿ®ÿØŸàŸÜ reverse - ÿØÿßÿØŸá‚ÄåŸáÿß ŸÇÿ®ŸÑÿßŸã sorted ÿ¥ÿØŸá‚ÄåÿßŸÜÿØ
                    const sortedData = [...historyData];

                    // ÿ¢ŸÖÿßÿØŸá‚Äåÿ≥ÿßÿ≤€å ÿØÿßÿØŸá‚ÄåŸáÿß
                    let chartConfig = {};

                    const labels = sortedData.map(item => {
                        const time = item.time ? item.time.substring(0, 5) : item.date ? item.date.substring(5) : '--';
                        return time;
                    });

                    const prices = sortedData.map(item => parseFloat(item.price || item.close || 0));

                    // ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸàÿπ ŸÜŸÖŸàÿØÿßÿ±
                    switch (chartState.currentChartType) {
                        case 'line':
                            chartConfig = createLineChart(labels, prices, name, symbol, sortedData);
                            break;
                        case 'line-markers':
                            chartConfig = createLineWithMarkersChart(labels, prices, name, symbol, sortedData);
                            break;
                        case 'step-line':
                            chartConfig = createStepLineChart(labels, prices, name, symbol, sortedData);
                            break;
                        case 'area':
                            chartConfig = createAreaChart(labels, prices, name, symbol, sortedData);
                            break;
                        case 'bars':
                            chartConfig = createBarsChart(labels, prices, name, symbol, sortedData);
                            break;
                        case 'columns':
                            chartConfig = createColumnsChart(labels, prices, name, symbol, sortedData);
                            break;
                        case 'candles':
                        case 'hollow-candles':
                            // ÿ®ÿ±ÿß€å ÿ¥ŸÖÿπ‚ÄåŸáÿß OHLC ÿØÿßÿØŸá ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ
                            chartConfig = createCandleChart(labels, sortedData, name, symbol);
                            break;
                        default:
                            chartConfig = createLineChart(labels, prices, name, symbol, sortedData);
                    }

                    // ÿß€åÿ¨ÿßÿØ ŸÜŸÖŸàÿØÿßÿ± ÿ¨ÿØ€åÿØ
                    chartInstance = new Chart(ctx, chartConfig);

                    // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ crosshair functionality
                    setupChartCrosshair(chartInstance, sortedData);
                }

                // Chart creation functions
                function createLineChart(labels, prices, name, symbol, sortedData) {
                    return {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: prices,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 2.5,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#667eea',
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                hoverBorderWidth: 3
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'line')
                    };
                }

                function createLineWithMarkersChart(labels, prices, name, symbol, sortedData) {
                    return {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: prices,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 2.5,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#667eea',
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                hoverBorderWidth: 3
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'line-markers')
                    };
                }

                function createStepLineChart(labels, prices, name, symbol, sortedData) {
                    return {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: prices,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                borderWidth: 2.5,
                                fill: true,
                                stepped: true,
                                tension: 0,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#667eea',
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                hoverBorderWidth: 3
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'step-line')
                    };
                }

                function createAreaChart(labels, prices, name, symbol, sortedData) {
                    return {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: prices,
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.3)',
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 6,
                                pointBackgroundColor: '#764ba2',
                                pointBorderColor: 'white',
                                pointBorderWidth: 2,
                                hoverBorderWidth: 3
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'area')
                    };
                }

                function createBarsChart(labels, prices, name, symbol, sortedData) {
                    return {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: prices,
                                backgroundColor: prices.map((price, idx) =>
                                    idx === 0 || prices[idx] >= prices[idx - 1] ? '#10b981' : '#ef4444'
                                ),
                                borderRadius: 2,
                                barThickness: 'flex',
                                maxBarThickness: 20
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'bars', true)
                    };
                }

                function createColumnsChart(labels, prices, name, symbol, sortedData) {
                    return {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: prices,
                                backgroundColor: prices.map((price, idx) =>
                                    idx === 0 || prices[idx] >= prices[idx - 1] ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'
                                ),
                                borderRadius: 4,
                                barThickness: 'flex',
                                maxBarThickness: 16
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'columns', true)
                    };
                }

                function createCandleChart(labels, sortedData, name, symbol) {
                    // ÿ¥ŸÖÿπ‚ÄåŸáÿß€å ÿØÿ±ÿ≥ÿ™ - open/close ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ÿ±ŸÜ⁄Ø
                    const candleData = sortedData.map((item, idx) => {
                        // ÿß⁄Øÿ± OHLC ⁄à€åŸπÿß €Å€í ÿ™Ÿà ÿßÿ≥ÿ™ÿπŸÖÿßŸÑ ⁄©ÿ±€å⁄∫
                        if (item.open !== undefined && item.close !== undefined) {
                            return {
                                o: parseFloat(item.open),
                                h: parseFloat(item.high),
                                l: parseFloat(item.low),
                                c: parseFloat(item.close),
                                color: parseFloat(item.close) >= parseFloat(item.open) ? '#10b981' : '#ef4444'
                            };
                        }

                        // €åÿß ÿß⁄Øÿ± ÿµÿ±ŸÅ price €Å€í
                        const price = parseFloat(item.price || item.close || 0);
                        const prevPrice = idx > 0 ? parseFloat(sortedData[idx - 1].price || sortedData[idx - 1].close || 0) : price;

                        return {
                            o: prevPrice,
                            h: Math.max(price, prevPrice),
                            l: Math.min(price, prevPrice),
                            c: price,
                            color: price >= prevPrice ? '#10b981' : '#ef4444'
                        };
                    });

                    // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ÿ±€å⁄∫ bar chart ÿ¥ŸÖÿπ‚Äå Ÿà⁄∫ ⁄©€í ŸÑ€å€í
                    return {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: `ŸÇ€åŸÖÿ™ ${name} (${symbol})`,
                                data: candleData.map(c => c.c),
                                backgroundColor: candleData.map(c => c.color),
                                borderColor: candleData.map(c => c.color),
                                borderWidth: 1,
                                borderRadius: 2,
                                barThickness: 'flex',
                                maxBarThickness: 8
                            }]
                        },
                        options: getDefaultChartOptions(name, symbol, sortedData, 'candles', true)
                    };
                }

                function getDefaultChartOptions(name, symbol, sortedData, chartType, isBar = false) {
                    return {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    font: { family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif", size: 14, weight: 'bold' },
                                    padding: 15,
                                    usePointStyle: true,
                                    color: document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333'
                                }
                            },
                            tooltip: {
                                enabled: false // ÿ∫€åÿ±ŸÅÿπÿßŸÑ ⁄©ÿ±ÿØŸÜ tooltip Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ÿ®ÿ±ÿß€å crosshair
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'ŸÇ€åŸÖÿ™ (ÿ™ŸàŸÖÿßŸÜ)',
                                    color: document.body.classList.contains('dark-mode') ? '#e0e0e0' : '#333'
                                },
                                ticks: {
                                    callback: function (value) {
                                        return formatPrice(value);
                                    },
                                    font: { size: 11 },
                                    color: document.body.classList.contains('dark-mode') ? '#aaa' : '#666'
                                },
                                grid: {
                                    color: document.body.classList.contains('dark-mode') ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 11 },
                                    color: document.body.classList.contains('dark-mode') ? '#aaa' : '#666'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    };
                }

                // Setup Crosshair Functionality
                function setupChartCrosshair(chart, sortedData) {
                    const canvas = chart.canvas;
                    const container = canvas.parentElement;

                    let tooltip = document.querySelector('.chart-tooltip');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'chart-tooltip';
                        container.style.position = 'relative';
                        container.appendChild(tooltip);
                    }

                    canvas.addEventListener('mousemove', (e) => {
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        // ŸÖÿ≠ÿßÿ≥ÿ®Ÿá ŸÜÿ≤ÿØ€å⁄©‚Äåÿ™ÿ±€åŸÜ ŸÜŸÇÿ∑Ÿá
                        const canvasPosition = Chart.helpers.getRelativePosition(e, chart);
                        const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                        const dataY = chart.scales.y.getValueForPixel(canvasPosition.y);

                        // Ÿæ€åÿØÿß ⁄©ÿ±ÿØŸÜ ŸÜÿ≤ÿØ€å⁄©‚Äåÿ™ÿ±€åŸÜ ŸÜŸÇÿ∑Ÿá ÿØÿßÿØŸá
                        let closestIndex = Math.round(dataX);
                        closestIndex = Math.max(0, Math.min(closestIndex, sortedData.length - 1));

                        if (closestIndex >= 0 && closestIndex < sortedData.length) {
                            const data = sortedData[closestIndex];
                            const price = parseFloat(data.price);
                            const change = parseFloat(data.change_percent);
                            const changeIcon = change > 0 ? 'üìà' : change < 0 ? 'üìâ' : '‚öñÔ∏è';

                            tooltip.innerHTML = `
                        <div class="chart-tooltip-row">
                            <span class="chart-tooltip-label">‚è∞ ŸàŸÇÿ™:</span>
                            <span class="chart-tooltip-value">${data.date} ${data.time}</span>
                        </div>
                        <div class="chart-tooltip-row">
                            <span class="chart-tooltip-label">üí∞ ŸÇ€åŸÖÿ™:</span>
                            <span class="chart-tooltip-value">${formatPrice(price)}</span>
                        </div>
                        <div class="chart-tooltip-row">
                            <span class="chart-tooltip-label">üìä ÿ™ÿ∫€å€åÿ±:</span>
                            <span class="chart-tooltip-value">${change >= 0 ? '+' : ''}${change.toFixed(2)}% ${changeIcon}</span>
                        </div>
                    `;

                            // Calculate tooltip position with boundary checks
                            let posX = x + 20;
                            let posY = y - 80;

                            // Check right boundary (tooltip width ~250px)
                            if (posX + 250 > container.clientWidth) {
                                posX = Math.max(5, x - 250 - 10);
                            }

                            // Check top boundary
                            if (posY < 0) {
                                posY = y + 10;
                            }

                            // Check bottom boundary (tooltip height ~100px)
                            if (posY + 100 > container.clientHeight) {
                                posY = Math.max(5, container.clientHeight - 100 - 10);
                            }

                            tooltip.style.left = Math.max(5, posX) + 'px';
                            tooltip.style.top = Math.max(5, posY) + 'px';
                            tooltip.classList.add('visible');
                        }
                    });

                    canvas.addEventListener('mouseleave', () => {
                        tooltip.classList.remove('visible');
                    });

                    // Touch support for mobile
                    canvas.addEventListener('touchmove', (e) => {
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;

                        const canvasPosition = Chart.helpers.getRelativePosition(touch, chart);
                        const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                        let closestIndex = Math.round(dataX);
                        closestIndex = Math.max(0, Math.min(closestIndex, sortedData.length - 1));

                        if (closestIndex >= 0 && closestIndex < sortedData.length) {
                            const data = sortedData[closestIndex];
                            const price = parseFloat(data.price);
                            const change = parseFloat(data.change_percent);
                            const changeIcon = change > 0 ? 'üìà' : change < 0 ? 'üìâ' : '‚öñÔ∏è';

                            tooltip.innerHTML = `
                        <div class="chart-tooltip-row">
                            <span class="chart-tooltip-label">‚è∞ ŸàŸÇÿ™:</span>
                            <span class="chart-tooltip-value">${data.date} ${data.time}</span>
                        </div>
                        <div class="chart-tooltip-row">
                            <span class="chart-tooltip-label">üí∞ ŸÇ€åŸÖÿ™:</span>
                            <span class="chart-tooltip-value">${formatPrice(price)}</span>
                        </div>
                        <div class="chart-tooltip-row">
                            <span class="chart-tooltip-label">üìä ÿ™ÿ∫€å€åÿ±:</span>
                            <span class="chart-tooltip-value">${change >= 0 ? '+' : ''}${change.toFixed(2)}% ${changeIcon}</span>
                        </div>
                    `;

                            // Calculate tooltip position with boundary checks
                            let posX = x + 20;
                            let posY = y - 80;

                            // Check right boundary (tooltip width ~250px)
                            if (posX + 250 > container.clientWidth) {
                                posX = Math.max(5, x - 250 - 10);
                            }

                            // Check top boundary
                            if (posY < 0) {
                                posY = y + 10;
                            }

                            // Check bottom boundary (tooltip height ~100px)
                            if (posY + 100 > container.clientHeight) {
                                posY = Math.max(5, container.clientHeight - 100 - 10);
                            }

                            tooltip.style.left = Math.max(5, posX) + 'px';
                            tooltip.style.top = Math.max(5, posY) + 'px';
                            tooltip.classList.add('visible');
                        }
                    });

                    canvas.addEventListener('touchend', () => {
                        tooltip.classList.remove('visible');
                    });
                }

                // Handle Chart Type Button Clicks
                // ===== Dropdown Functions =====
                function toggleChartTypeDropdown() {
                    const dropdown = document.getElementById('chartTypeDropdown');
                    const toggle = document.getElementById('chartTypeToggle');
                    dropdown.classList.toggle('active');
                    toggle.classList.toggle('active');
                    closeTimeframeDropdown();
                }

                function toggleTimeframeDropdown() {
                    const dropdown = document.getElementById('timeframeDropdown');
                    const toggle = document.getElementById('timeframeToggle');
                    dropdown.classList.toggle('active');
                    toggle.classList.toggle('active');
                    closeChartTypeDropdown();
                }

                function closeChartTypeDropdown() {
                    const dropdown = document.getElementById('chartTypeDropdown');
                    const toggle = document.getElementById('chartTypeToggle');
                    dropdown.classList.remove('active');
                    toggle.classList.remove('active');
                }

                function closeTimeframeDropdown() {
                    const dropdown = document.getElementById('timeframeDropdown');
                    const toggle = document.getElementById('timeframeToggle');
                    dropdown.classList.remove('active');
                    toggle.classList.remove('active');
                }

                function selectChartType(type) {
                    chartState.currentChartType = type;
                    document.getElementById('chartTypeLabel').textContent =
                        document.querySelector(`[data-type="${type}"]`).textContent;

                    document.querySelectorAll('#chartTypeDropdown .dropdown-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-type') === type) {
                            item.classList.add('active');
                        }
                    });

                    closeChartTypeDropdown();
                    if (chartState.historicalData.length > 0) {
                        renderChart(chartState.historicalData, chartState.currentSymbol, chartState.currentName);
                    }
                }

                async function selectTimeframe(timeframe) {
                    console.log(`‚è±Ô∏è selectTimeframe ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å ÿ¥ÿØ - timeframe: ${timeframe}`);

                    chartState.currentTimeframe = timeframe;
                    const timeframeLabels = {
                        '1m': '1ÿØ', '3m': '3ÿØ', '5m': '5ÿØ', '15m': '15ÿØ', '30m': '30ÿØ', '45m': '45ÿØ',
                        '1h': '1ÿ≥', '2h': '2ÿ≥', '3h': '3ÿ≥', '4h': '4ÿ≥',
                        '1d': '1ÿ±', '1w': '1Ÿá', '1mo': '1ŸÖ', '3mo': '3ŸÖ', '6mo': '6ŸÖ', '1y': '1ÿ≥'
                    };
                    document.getElementById('timeframeLabel').textContent = timeframeLabels[timeframe] || timeframe;

                    document.querySelectorAll('#timeframeDropdown .dropdown-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.getAttribute('data-timeframe') === timeframe) {
                            item.classList.add('active');
                        }
                    });

                    closeTimeframeDropdown();

                    // ŸÜŸÖÿß€åÿ¥ loading
                    const chartContainer = document.querySelector('.chart-container');
                    chartContainer.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px;">
                    <div style="width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="color: #999; font-size: 14px;">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÜŸÖŸàÿØÿßÿ±...</p>
                </div>
            `;

                    // ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ¨ÿØ€åÿØ
                    console.log(`‚è≥ fetchHistoryData ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å ŸÖ€å‚Äåÿ¥ŸàÿØ ÿ®ÿ±ÿß€å: ${chartState.currentSymbol}`);
                    await fetchHistoryData(chartState.currentSymbol);
                    console.log(`‚úÖ fetchHistoryData ÿ™ŸÖÿßŸÖ ÿ¥ÿØ`);
                }

                // ===== Zoom Functions =====
                let currentZoom = 1;

                function zoomChart(factor) {
                    currentZoom *= factor;
                    currentZoom = Math.max(0.5, Math.min(2.5, currentZoom)); // ÿ≠ÿØÿßŸÇŸÑ 0.5x Ÿà ÿ≠ÿØÿß⁄©ÿ´ÿ± 2.5x
                    applyZoom();
                }

                function resetZoom() {
                    currentZoom = 1;
                    applyZoom();
                }

                function applyZoom() {
                    const canvas = document.getElementById('priceChart');
                    const container = document.querySelector('.chart-container');

                    if (canvas && container) {
                        // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ transform ÿ®ÿ±ÿß€å zoom
                        canvas.style.transform = `scale(${currentZoom})`;
                        canvas.style.transformOrigin = 'center top';

                        // ÿ™ŸÜÿ∏€åŸÖ container ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ zoom ÿ¥ÿØŸá
                        container.style.overflow = currentZoom > 1 ? 'auto' : 'visible';
                    }

                    const zoomLevel = document.getElementById('zoomLevel');
                    if (zoomLevel) {
                        zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
                    }
                }

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    const chartTypeDropdown = document.getElementById('chartTypeDropdown');
                    const timeframeDropdown = document.getElementById('timeframeDropdown');
                    const chartTypeToggle = document.getElementById('chartTypeToggle');
                    const timeframeToggle = document.getElementById('timeframeToggle');

                    if (chartTypeDropdown && !chartTypeDropdown.parentElement.contains(e.target) &&
                        !chartTypeToggle.contains(e.target)) {
                        closeChartTypeDropdown();
                    }

                    if (timeframeDropdown && !timeframeDropdown.parentElement.contains(e.target) &&
                        !timeframeToggle.contains(e.target)) {
                        closeTimeframeDropdown();
                    }
                });

                function setupChartTypeButtons() {
                    // ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿßÿ¨ÿ© - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ dropdown ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ∞ŸÑŸÉ
                }

                // Handle Timeframe Button Clicks
                function setupTimeframeButtons() {
                    // ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ÿßÿ¨ÿ© - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ dropdown ÿ®ÿØŸÑÿßŸã ŸÖŸÜ ÿ∞ŸÑŸÉ
                }

                // Clear Search Input
                function clearSearch() {
                    const searchInput = document.getElementById('searchInput');
                    const clearBtn = document.getElementById('searchClear');
                    searchInput.value = '';
                    clearBtn.classList.remove('visible');
                    filterAndRender();
                    searchInput.focus();
                }

                // Event Listeners
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    const clearBtn = document.getElementById('searchClear');
                    if (e.target.value.length > 0) {
                        clearBtn.classList.add('visible');
                    } else {
                        clearBtn.classList.remove('visible');
                    }
                    filterAndRender();
                });

                // Close Modal on Outside Click
                // Close Modal on Escape Key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && document.getElementById('chartModal').classList.contains('active')) {
                        closeChartModal();
                    }
                });

                // Initial Load
                fetchData();
                updateNavDateTime();
                loadDarkModePreference();
                setInterval(updateNavDateTime, 60000);

                // Set initial theme indicator for nav tabs
                document.querySelectorAll('.nav-tab').forEach((tab, index) => {
                    if (index === 0) {
                        tab.classList.add('active');
                    } else {
                        tab.classList.remove('active');
                    }
                });

                // Update indicator on initial load (with skipTransition) and window resize
                setTimeout(() => updateIndicator(true), 0);
                window.addEventListener('resize', () => updateIndicator(false));

                // ÿ¨ŸÑŸà⁄Ø€åÿ±€å ÿßÿ≤ ÿ±Ÿà€åÿØÿßÿØ mousedown ÿ±Ÿà€å ÿ™ÿµÿßŸà€åÿ± ÿØÿßÿÆŸÑ ⁄©ÿßÿ±ÿ™‚ÄåŸáÿß
                document.addEventListener('mousedown', (e) => {
                    if (e.target.tagName === 'IMG' && e.target.closest('.card-icon')) {
                        e.preventDefault();
                        return false;
                    }
                }, true);

                document.addEventListener('dragstart', (e) => {
                    if (e.target.tagName === 'IMG' && e.target.closest('.card-icon')) {
                        e.preventDefault();
                        return false;
                    }
                }, true);

                document.addEventListener('dragover', (e) => {
                    if (e.target.tagName === 'IMG' && e.target.closest('.card-icon')) {
                        e.preventDefault();
                        return false;
                    }
                }, true);

                // Pull to Refresh for Mobile - ÿ®Ÿáÿ®ŸàÿØ‚Äåÿ¥ÿØŸá
                let pullStartY = 0;
                let isPulling = false;
                let isLoading = false;
                const pullThreshold = 80;
                let pullDistance = 0;

                function showPullToRefreshIndicator() {
                    // ÿ®ÿØŸàŸÜ animation - ŸÅŸÇÿ∑ ÿ¥ÿ±Ÿàÿπ ŸÑŸàÿØ
                }

                function hidePullToRefreshIndicator() {
                    // ÿ®ÿØŸàŸÜ animation - ŸÅŸÇÿ∑ Ÿæÿß€åÿßŸÜ ŸÑŸàÿØ
                }

                function hideSearchAndCardsForRefresh() {
                    // ÿ®ÿØŸàŸÜ animation - ŸÅŸÇÿ∑ ÿ¥ÿ±Ÿàÿπ
                }

                function showSearchAndCardsAfterRefresh() {
                    // ÿ®ÿØŸàŸÜ animation - ŸÅŸÇÿ∑ Ÿæÿß€åÿßŸÜ
                }

                document.addEventListener('touchstart', (e) => {
                    if (window.pageYOffset === 0) {
                        pullStartY = e.touches[0].clientY;
                        isPulling = true;
                        pullDistance = 0;
                    }
                }, { passive: true });

                document.addEventListener('touchmove', (e) => {
                    if (isPulling && window.pageYOffset === 0 && !isLoading) {
                        pullDistance = e.touches[0].clientY - pullStartY;

                        if (pullDistance > 0) {
                            // ŸÜŸÖÿß€åÿ¥ indicator ŸáŸÜ⁄ØÿßŸÖ ⁄©ÿ¥€åÿØŸÜ
                            if (pullDistance > pullThreshold / 2) {
                                showPullToRefreshIndicator();
                            }
                        }
                    }
                }, { passive: true });

                document.addEventListener('touchend', (e) => {
                    if (isPulling && !isLoading) {
                        if (pullDistance > pullThreshold) {
                            // ÿ¥ÿ±Ÿàÿπ ŸÑŸàÿØ€åŸÜ⁄Ø
                            isLoading = true;
                            hideSearchAndCardsForRefresh();
                            showPullToRefreshIndicator();

                            // ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å fetch Ÿà ÿ≥Ÿæÿ≥ ŸæŸÜŸáÿßŸÜ ⁄©ÿ±ÿØŸÜ
                            fetchData().then(() => {
                                // ŸÖŸÜÿ™ÿ∏ÿ± ⁄©ŸÖ€å ÿ®ÿ±ÿß€å ÿßŸÜ€åŸÖ€åÿ¥ŸÜ
                                setTimeout(() => {
                                    showSearchAndCardsAfterRefresh();
                                    setTimeout(() => {
                                        hidePullToRefreshIndicator();
                                        isLoading = false;
                                    }, 500);
                                }, 200);
                            }).catch(() => {
                                setTimeout(() => {
                                    showSearchAndCardsAfterRefresh();
                                    setTimeout(() => {
                                        hidePullToRefreshIndicator();
                                        isLoading = false;
                                    }, 500);
                                }, 200);
                            });
                        } else {
                            // ÿß⁄Øÿ± ⁄©ÿßŸÅ€å ⁄©ÿ¥€åÿØŸá ŸÜÿ¥ŸàÿØÿå ŸæŸÜŸáÿßŸÜ ⁄©ŸÜ€åÿØ
                            hidePullToRefreshIndicator();
                        }
                    }
                    isPulling = false;
                    pullDistance = 0;
                }, { passive: true });

                // Auto Refresh Every Minute
                setInterval(fetchData, 60000);

                // Handle window resize for chart responsiveness
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        // ÿß⁄Øÿ± ŸÜŸÖŸàÿØÿßÿ± ÿ®ÿßÿ≤ ÿ®ÿßÿ¥ÿØÿå ÿ¢ŸÜ ÿ±ÿß re-render ⁄©ŸÜ€åŸÖ
                        if (document.getElementById('chartModal').classList.contains('active') &&
                            chartState.historicalData.length > 0) {
                            renderChart(chartState.historicalData, chartState.currentSymbol, chartState.currentName);
                        }
                    }, 250);
                });

                // Initialize chart controls when modal is shown
                const chartModal = document.getElementById('chartModal');
                const originalShowChart = window.openChartModal;

                // Ensure chart controls are set up on first use
                setTimeout(() => {
                    setupChartTypeButtons();
                    setupTimeframeButtons();
                }, 100);
            </script>
</body>

</html>
